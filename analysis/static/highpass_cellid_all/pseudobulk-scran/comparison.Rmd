---
title: "R Notebook"
output: html_notebook
---
```{r}
library(tidyverse)
library(mashr)
library(corrplot)
```


## Comparing the number of sh- and sp-eQTLs detected from both approaches


## Comparing effect sizes and standard errors
First, load the combined QTL outputs from both analyses.
```{r}
basic_qtls <- readRDS("/project2/gilad/jpopp/ebQTL/temp/highpass_cellid_all.pseudobulk-scran.basic.qtls_combined.rds")

fastgxc_qtls <- readRDS("/project2/gilad/jpopp/ebQTL/temp/highpass_cellid_all.pseudobulk-scran.fastgxc.qtls_combined.rds")
```

Compare the effect size estimates from the two approaches
```{r fig.width=15, fig.height=15}
basic_bhats <- select(basic_qtls, c(gv, beta, type)) %>%
  rename(basic_beta=beta)

bhats_comp <- select(fastgxc_qtls, c(gv, beta, type)) %>%
  rename(fastgxc_beta=beta) %>%
  inner_join(basic_bhats, by=c("gv", "type")) 

test <- sample_frac(bhats_comp, 0.01)

ggplot(test, aes(x=basic_beta, y=fastgxc_beta)) +
  geom_point() +
  geom_abline(intercept=0, slope=1, color="red", linetype="dashed") +
  facet_wrap(~type, ncol=5, scales="free")
```
A few cell types (Erythroblasts, especially) are looking a bit too spherical. But in general I don't see a distinct trend, and the results are certainly correlated.

Compare the standard error estimates from the two approaches
```{r fig.width=15, fig.height=15}
basic_shats <- select(basic_qtls, c(gv, se, type)) %>%
  rename(basic_se=se)

shats_comp <- select(fastgxc_qtls, c(gv, se, type)) %>%
  rename(fastgxc_se=se) %>%
  inner_join(basic_shats, by=c("gv", "type")) 

test <- sample_frac(shats_comp, 0.01)

ggplot(test, aes(x=basic_se, y=fastgxc_se)) +
  geom_point() +
  geom_abline(intercept=0, slope=1, color="red", linetype="dashed") +
  facet_wrap(~type, ncol=5, scales="free")
```
Here there is definitely more mass above the diagonal, suggesting that the basic approach has smaller standard errors than the fastgxc approach.

## Comparing the correlation structure modeled by either approach
First, for each pair of cell types we can define how many individuals have a pseudobulk sample represented in each cell type
```{r}
basic_sample_summary <- read_tsv("/project2/gilad/jpopp/ebQTL/data/static/highpass_cellid_all/pseudobulk-scran/basic/sample_summary_manual.tsv")
fastgxc_sample_summary <- read_tsv("/project2/gilad/jpopp/ebQTL/data/static/highpass_cellid_all/pseudobulk-scran/fastgxc/sample_summary_manual.tsv")
```

View a correlation matrix based on sample overlap
```{r}
basic_inds <- basic_sample_summary %>%
  filter(!dropped) %>%
  select(type, individual) %>%
  group_by(type) %>%
  nest()

sample_overlap <- basic_inds %>%
  select(type) %>% ungroup %>%
  mutate(type2=factor(type), type1=factor(type), .keep="unused") %>%
  tidyr::expand(type1, type2) %>%
  left_join(basic_inds, by=c("type1"="type")) %>%
  left_join(basic_inds, by=c("type2" = "type")) %>%
  mutate(overlap=map2_dbl(data.x, data.y, function(x, y){nrow(intersect(x, y))}), .keep="unused") %>%
  pivot_wider(names_from=type2, values_from=overlap) %>%
  column_to_rownames("type1")

test3 <- as.matrix(test2)
corrplot(test3, is.corr=F, tl.pos='l')
```


```{r}
cell.types <- unique(basic_sample_summary$type)
inds <- unique(as.character(basic_sample_summary$individual))

sample.overlap.matrix <- matrix(0, nrow=length(cell.types), ncol=length(cell.types), dimnames=list(cell.types, cell.types))

for (i in seq(length(cell.types))) {
  for (j in seq(length(cell.types))) {
    for (k in inds) {
      in_basic = filter(basic_sample_summary, ind_type==paste0(k, "_", cell.types[i]))$dropped
      in_fastgxc = filter(fastgxc_sample_summary, ind_type==paste0(k, "_", cell.types[i]))$dropped
      if (in_basic & in_fastgxc) {
        sample.overlap.matrix[i, j] = sample.overlap.matrix[i, j] + 1
      }
    }
  }
}

corrplot(sample.overlap.matrix, is.corr=F, pch.cex=0.1, tl.pos='l')
```

