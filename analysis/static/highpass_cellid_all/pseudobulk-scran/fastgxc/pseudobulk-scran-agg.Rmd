---
title: "Pseudobulk Aggregation"
output: html_notebook
---
```{r, echo=FALSE, results=FALSE, warning=FALSE}
library(tidyverse)
```

## Overview of Filtered Pseudobulk Data
First, which cell types are included in this analysis (after filtering out samples with too few cells)?
```{r, warning=FALSE, message=FALSE}
sample_summary <- read_tsv("/project2/gilad/jpopp/ebQTL/data/static/highpass_cellid_all/pseudobulk-scran/fastgxc/sample_summary_manual.tsv") %>%
  mutate(individual=factor(individual), type=factor(type))

cell.types <- sample_summary  %>%
  mutate(type=as.character(type)) %>%
  filter(!dropped) %>%
  count(type) %>%
  filter(n > 25) %>%
  pull(type)

cell.types
```

How many samples do we have per cell type?
```{r}
sample_summary  %>%
  filter(!dropped) %>%
  count(type) %>%
  ggplot(aes(x=type, y=n, fill=type)) +
  geom_bar(stat="identity") +
  ylab("n samples") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle = 45, hjust=1), legend.position="none") +
  geom_abline(slope=0, intercept=25, linetype="dashed")
```

How many cell types do we have per individual?
```{r}
sample_summary %>%
  filter(!dropped) %>%
  filter(type %in% cell.types) %>%
  count(individual) %>%
  arrange(n) %>%
  ggplot(aes(x=individual, y=n)) +
  geom_bar(stat="identity") +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

## Per-sample quality control
```{r}
knitr::include_graphics(paste0("/project2/gilad/jpopp/ebQTL/figs/static/highpass_cellid_all/pseudobulk-scran/fastgxc/", cell.types, "/qc.png"))
```