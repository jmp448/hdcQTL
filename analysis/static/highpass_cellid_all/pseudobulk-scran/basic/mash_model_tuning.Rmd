---
title: "Mash Model Tuning"
output: html_notebook
---

```{r}
library(tidyverse)
library(mashr)
library(corrplot)
```


## Estimating correlation
First, we compare three methods for estimating correlation structure
```{r}
load("/project2/gilad/jpopp/ebQTL/results/static/highpass_cellid_all/pseudobulk-scran/basic/mashr_corr_eval.RData")
```

```{r}
tibble("method"=c("no_corr", "simple", "EM"),
       "loglik"=c(get_loglik(m.orig.test),
                  get_loglik(m.Vsimple.test),
                  get_loglik(m.Vem.test))) %>%
  mutate(method=factor(method, levels=c("EM", "simple", "no_corr"))) %>%
  ggplot(aes(x=method, y=loglik)) +
  geom_bar(stat="identity") +
  coord_flip()
```
We can see that the EM procedure offers the highest log likelihood, so we'll move forward with that. 

## Comparing correlation 
When directly comparing the correlation matrices learned by these two approaches we see that they 
follow a similar pattern but the EM approach offers higher magnitude correlations
```{r}
corrplot(V.simple, pch.cex=0.1, tl.pos='l')
corrplot(V.em, pch.cex=0.1, tl.pos='l')
```

It looks like the two matrices are highly correlated but the simple approach just underestimates the magnitudes
```{r}
tibble("simple"=as.vector(V.simple)[as.vector(V.simple) != 1], "EM"=as.vector(V.em)[as.vector(V.simple) != 1]) %>%
  ggplot(aes(x=simple, y=EM)) +
  geom_point() +
  geom_abline(slope=1, intercept=0, linetype="dashed", color="red")
```

## Tuning alpha
```{r}
logliks <- read_tsv("/project2/gilad/jpopp/ebQTL/results/static/highpass_cellid_all/pseudobulk-scran/basic/mashr_alpha_eval.tsv") %>%
  mutate(alpha=factor(alpha))
```

```{r}
logliks %>%
  ggplot(aes(x=alpha, y=loglik)) +
  geom_bar(stat="identity") +
  coord_flip()
```
Looks like choice of alpha doesn't make a huge difference but the EE model works best (alpha=0, largest log likelihood).

## Data-Driven Covariance Matrices
```{r}
load("/project2/gilad/jpopp/ebQTL/results/static/highpass_cellid_all/pseudobulk-scran/basic/mashr_U_eval.RData")
```

```{r}
U_eval <- tibble("method"=c("canonical", "default", "default_EZ",
                  "paper", "paper_EZ"),
       "loglik"=c(get_loglik(m.simple.test),
                  get_loglik(m.default.test),
                  get_loglik(m.default.test.EZ),
                  get_loglik(m.paper.test),
                  get_loglik(m.paper.test.EZ))) 

U_eval %>%
  mutate(method=factor(method, levels=c("canonical", "default", "default_EZ", "paper", "paper_EZ"))) %>%
  ggplot(aes(x=method, y=loglik)) +
  geom_bar(stat="identity") +
  coord_flip()
```


