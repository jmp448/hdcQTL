---
title: "Static and Context-Specific eQTL Calling with mashR"
output: html_notebook
---

```{r}
library(mashr)
library(corrplot)
library(tidyverse)
library(rmeta)
library(vroom)
```

## Quality Control

How many cells do we have per cell type and per individual?

```{r, fig.width=6.5, fig.height=20}
sample_summary <- read_tsv("/project2/gilad/jpopp/ebQTL/data/static/highpass_cellid_all/pseudobulk-scran/basic/sample_summary_manual.tsv") %>%
  mutate(individual=factor(individual), type=factor(type))

cell.types <- sample_summary  %>%
  mutate(type=as.character(type)) %>%
  filter(!dropped) %>%
  count(type) %>%
  filter(n > 25) %>%
  pull(type)

sample_summary %>%
  filter(type %in% cell.types) %>%
  arrange(n_cells) %>%
  ggplot(aes(x=individual, y=n_cells)) +
  geom_bar(stat="identity") +
  facet_grid(rows=vars(type), scales="free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```
What's the median number of cells per individual?
```{r}
sample_summary %>%
  filter(!dropped) %>%
  filter(type %in% cell.types) %>%
  group_by(type) %>%
  summarize(median=median(n_cells)) %>%
  ggplot(aes(x=type, y=median)) +
    geom_bar(stat="identity") +
    geom_abline(slope=0, intercept=95, linetype="dashed", color="red") +
    coord_flip()
```

How many cell types per individual?
```{r}
sample_summary %>%
  filter(!dropped) %>%
  filter(type %in% cell.types) %>%
  dplyr::count(individual) %>%
  arrange(n) %>%
  ggplot(aes(x=individual, y=n)) +
  geom_bar(stat="identity") +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

For each cell type, how many individuals are included? (Must have at least 5 cells)

```{r, fig.width=12, fig.height=6}
sample_summary  %>%
  filter(!dropped) %>%
  count(type) %>%
  ggplot(aes(x=type, y=n, fill=type)) +
  geom_bar(stat="identity") +
  ylab("n samples") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle = 45, hjust=1), legend.position="none") +
  geom_abline(slope=0, intercept=25, linetype="dashed")
```

## Evaluating eQTL detection rates with and without mashR

How many eQTLs do we find with and without mashR?

### eQTL detection without mashR

```{r}
cell.types <- sample_summary  %>%
  mutate(type=as.character(type)) %>%
  filter(!dropped) %>%
  count(type) %>%
  filter(n > 25) %>%
  pull(type)
```

```{r}
pull_type <- function(s) {
  str_split(s, "/")[[1]][11]
}

prefix <- "/project2/gilad/jpopp/ebQTL/results/static/highpass_cellid_all/pseudobulk-scran/basic/"
all_qtls <- vroom(paste0(prefix, cell.types, "/matrixeqtl.cis_qtl_pairs.tophits.tsv"), id="path", col_select=c(SNP, gene, bonf.p, q, path)) %>%
  mutate(type=sapply(path, pull_type), .keep="unused")
```

```{r}
qtls_per_type <- all_qtls %>%
  unite(gv, SNP, gene, sep="--") %>%
  select(gv, q, type) %>%
  group_by(type) %>%
  filter(q<=0.1) %>% 
  count

ggplot(qtls_per_type, aes(x=type, y=n)) +
  geom_bar( stat="identity") +
  geom_abline(slope=0, intercept=235, linetype="dashed", color="red") +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  ) +
  ylab("# Genes with eQTL") + xlab("FCA-Annotated Cell Type")
```

What's driving the difference in detection rates?
```{r}
sample_summary  %>%
  mutate(type=as.character(type)) %>%
  filter(!dropped) %>%
  count(type) %>% rename(n_inds=n) %>%
  inner_join(qtls_per_type, by="type") %>%
  rename(n_qtl=n) %>%
  ggplot(aes(x=n_inds, y=n_qtl)) +
  geom_point(size=4) +
  theme_classic(base_size=20) +
  theme(legend.position = "none")
```
```{r}
sample_summary  %>%
  mutate(type=as.character(type)) %>%
  filter(!dropped) %>%
  group_by(type) %>%
  summarize(median=median(n_cells)) %>%
  inner_join(qtls_per_type, by="type") %>%
  rename(n_qtl=n) %>%
  ggplot(aes(x=median, y=n_qtl)) +
  geom_point(size=4) +
  theme_classic(base_size=20) +
  theme(legend.position = "none")
```
### eQTL detection with mashR

```{r}
m <- readRDS("/project2/gilad/jpopp/ebQTL/results/static/highpass_cellid_all/pseudobulk-scran/basic/mashr.tophits.rds")
```

```{r, fig.width=6, fig.height=5}
n_qtl <- colSums(m$result$lfsr <= 0.05)

qtls_per_type_mashr <- tibble(type=names(n_qtl), n_eqtl=n_qtl)  %>% 
  arrange(n_qtl)

ggplot(qtls_per_type_mashr, aes(x=type, y=n_eqtl)) +
  geom_segment( aes(x=type, xend=type, y=0, yend=n_eqtl), color="skyblue") +
  geom_point( color="blue", size=8, alpha=0.6) +
  theme_light(base_size=25) +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  ) +
  ylab("# Genes with eQTL") + xlab("FCA-Annotated Cell Type")
```

Check the covariance matrix \## Evaluating the correlation structure and sample sharing Now, it would be good to know if some of this is just due to sample overlap between contexts

```{r}
inds_per_type <- sample_summary %>%
  filter(!dropped) %>%
  filter(type %in% cell.types) %>%
  select(type, individual) %>%
  group_by(type) %>%
  nest()

sample_overlap <- inds_per_type %>%
  select(type) %>% ungroup %>%
  mutate(type2=factor(type), type1=factor(type), .keep="unused") %>%
  tidyr::expand(type1, type2) %>%
  left_join(inds_per_type, by=c("type1"="type")) %>%
  left_join(inds_per_type, by=c("type2" = "type")) %>%
  mutate(overlap=map2_dbl(data.x, data.y, function(x, y){nrow(intersect(x, y))}), .keep="unused") %>%
  arrange(type1, type2) %>%
  pivot_wider(names_from=type2, values_from=overlap) %>%
  column_to_rownames("type1")

corrplot(as.matrix(sample_overlap), is.corr=F, tl.pos='l')
```

```{r}
corrplot(get_pairwise_sharing(m), is.corr=F, tl.pos='l')
```

```{r}
load("/project2/gilad/jpopp/ebQTL/results/static/highpass_cellid_all/pseudobulk-scran/basic/mashr.training_data.RData")
corrplot(Vhat, tl.pos='l')
```

## Understanding Data-Driven Regulatory Patterns

```{r}
tibble(n_contexts=get_n_significant_conditions(m)) %>%
  filter(n_contexts >= 1) %>%
  dplyr::count(n_contexts, name="n_eqtl") %>%
  mutate(n_contexts=factor(n_contexts, levels=seq(1, ncol(m$result$lfsr)))) %>%
  ggplot(aes(x=n_contexts, y=n_eqtl)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15)
```


```{r}
tibble(n_contexts=get_n_significant_conditions(m)) %>%
  filter(n_contexts >= 1) %>%
  nrow(.)
```

Now, of the eQTLs that are specific to one context, which context is it?
```{r}
m$result$lfsr %>%
  as_tibble(rownames="gv") %>%
  pivot_longer(-gv, names_to="type", values_to="lfsr") %>%
  filter(lfsr<=0.05) %>%
  group_by(gv) %>%
  dplyr::select(-lfsr) %>%
  nest() %>%
  mutate(n_contexts=sapply(data, nrow)) %>%
  filter(n_contexts==1) %>%
  unnest(data) %>%
  mutate(type=factor(type)) %>%
  group_by(type) %>%
  dplyr::count() %>%
  ggplot(aes(x=type, y=n, fill=type)) +
  geom_bar(stat="identity") +
  theme_classic() +
  ylab("# Singleton eQTLs") +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```


```{r}
singletons_per_type <- m$result$lfsr %>%
  as_tibble(rownames="gv") %>%
  pivot_longer(-gv, names_to="type", values_to="lfsr") %>%
  filter(lfsr<=0.05) %>%
  group_by(gv) %>%
  dplyr::select(-lfsr) %>%
  nest() %>%
  mutate(n_contexts=sapply(data, nrow)) %>%
  filter(n_contexts==1) %>%
  unnest(data) %>%
  mutate(type=factor(type)) %>%
  group_by(type) %>%
  dplyr::count()
```

```{r}
sample_summary  %>%
  mutate(type=as.character(type)) %>%
  filter(!dropped) %>%
  group_by(type) %>%
  summarize(median=median(n_cells)) %>%
  inner_join(singletons_per_type, by="type") %>%
  rename(n_qtl=n) %>%
  ggplot(aes(x=median, y=n_qtl)) +
  geom_point(size=4) +
  theme_classic(base_size=20) +
  theme(legend.position = "none")
```
There's a ton for erythroblasts - needs follow-up. Maybe this is because those are not really erythroblasts but they're from the early ectoderm cluster where we have tons of cells.

Of the shared effects, how many contexts are they nominally significant in?
```{r}
n_contexts_nominal <- all_qtls %>%
  filter(q<=0.05) %>%
  unite(gv, gene, SNP, sep="--") %>%
  group_by(gv) %>% count() %>%
  rename(n_nominal=n)

n_contexts_mash <- as_tibble(get_n_significant_conditions(m), rownames="gv") %>%
  filter(value >= 1) %>%
  rename(n_mash=value)

n_contexts_either <- full_join(n_contexts_nominal, n_contexts_mash, by="gv") %>%
  replace_na(list(n_mash=0, n_nominal=0))

ggplot(n_contexts_either, aes(x=n_nominal, y=n_mash)) +
  geom_point()
```



### What are the strongest patterns?
How much weight does each covariance matrix receive?
```{r, fig.width=6, fig.height=8}
as_tibble(get_estimated_pi(m), rownames="component") %>%
  mutate(component=factor(component, levels=names(get_estimated_pi(m)))) %>%
  ggplot(aes(x=component, y=value)) +
  geom_bar(stat="identity") +
  scale_x_discrete(limits=rev) +
  xlab("Regulatory Pattern") +
  ylab("Weight") +
  coord_flip() +
  theme_classic(base_size = 20)
  #theme(axis.text.x = element_text(angle = 45, hjust=1))
```

How much weight is put on the data-driven covariance matrices as opposed to the canonical ones? In GTEx's implementation of mash, it was 80-20.
```{r}
as_tibble(get_estimated_pi(m), rownames="component") %>%
  mutate(category=if_else(str_sub(component, 1, 2)=="ED", "data-driven", "canonical")) %>%
  group_by(category) %>%
  summarize(contribution=sum(value))
```


Show more interesting covariance matrices
```{r}
germ_layer <- read_csv("/project2/gilad/katie/ebQTL/FetalReferenceCellTypes_GermLayerAnnotations.csv", col_select = -c(Notes)) %>%
  rename(celltype=`cell type`, layer=`Germ layer`) %>%
  group_by(celltype) %>% add_count() %>%
  mutate(layer=if_else(n > 1, "Ambiguous", layer)) %>%
  dplyr::select(celltype, layer) %>%
  distinct() %>%
  mutate(layer=factor(layer, levels=c("Ambiguous", "Ectoderm", "Neural crest", "Endoderm", "Mesoderm"))) %>%
  mutate(celltype=str_replace_all(celltype, c(" "="-", "_"="-")))

germlayer_levels <- c("Ambiguous", "Ectoderm", "Neural crest", "Endoderm", "Mesoderm")
germlayer_colors <- c("#D5D5D5", "#0076BA", "#006C65", "#FEAE00", "#A62228")
```

The main component that mashr uses draws a clean split down germ layer lines
```{r}
m$fitted_g$Ulist$ED_PCA_1 %>%
  corrplot(is.corr=F, tl.pos='l')

pc1 <- m$fitted_g$Ulist$ED_PCA_1 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="celltype") %>%
  left_join(germ_layer, by="celltype")
 
pc1 %>%
  ggplot(aes(x=celltype, y=value, fill=layer)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values=germlayer_colors) +
  coord_flip() +
  theme_classic() +
  ylab("PC1 Loading") + xlab("Cell Type")

m$fitted_g$Ulist$ED_PCA_2 %>%
  corrplot(is.corr=F, tl.pos='l')

pc2 <- m$fitted_g$Ulist$ED_PCA_2 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="celltype") %>%
  left_join(germ_layer, by="celltype")
 
pc2 %>%
  ggplot(aes(x=celltype, y=value, fill=layer)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values=germlayer_colors) +
  coord_flip() +
  theme_classic() +
  ylab("PC2 Loading") + xlab("Cell Type")

both_pcs <- pc1 %>%
  mutate(component="PC1") %>%
  bind_rows(mutate(pc2, component="PC2")) %>%
  rename(`Germ Layer`=layer)

fig <- both_pcs %>% 
  ggplot(aes(x=celltype, y=value, fill=`Germ Layer`)) +
  facet_grid(cols=vars(component)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values=germlayer_colors) +
  coord_flip() +
  theme_classic(base_size = 40) +
  ylab("Loading") + xlab("Cell Type")

png("/project2/gilad/jpopp/ebQTL/temp/components.png", width=3000, height=1600)
plot(fig)
dev.off()
```

```{r}
m$fitted_g$Ulist$ED_PCA_1 %>%
  corrplot(is.corr=F)

m$fitted_g$Ulist$ED_PCA_1 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  #mutate(type=factor(type, levels=type_levels)) %>%
  ggplot(aes(x=type, y=value, fill=type)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight")
```

## Examining Context-Specific eQTLs

Find any significant eQTLs whose effects are best explained by those signals, starting with component 1 (which is highest in IPSC, lower elsewhere)

```{r}
tests <- rownames(get_lfsr(m))
sighits <- get_significant_results(m)
ident <- as_tibble(m$posterior_weights) %>%
  rowid_to_column() %>%
  filter(rowid %in% sighits) %>%
  pivot_longer(-rowid, names_to="component", values_to="weight") %>%
  group_by(rowid) %>%
  slice_max(weight) %>%
  mutate(component=str_extract(component, "[^.]+")) %>%
  filter(component=="ED_tPCA") %>%
  pull(rowid)

celltype.colors <- germ_layer %>%
  left_join(tibble(layer=germlayer_levels, color=germlayer_colors), by="layer") %>%
  arrange(celltype) %>%
  filter(celltype %in% colnames(m$result$lfsr)) %>%
  pull(color)

mash_plot_meta(m, ident[1], colors=meta.colors(box=celltype.colors))
mash_plot_meta(m, ident[2], colors=meta.colors(box=celltype.colors))
mash_plot_meta(m, ident[3], colors=meta.colors(box=celltype.colors))
mash_plot_meta(m, ident[4], colors=meta.colors(box=celltype.colors))
mash_plot_meta(m, ident[5], colors=meta.colors(box=celltype.colors))
mash_plot_meta(m, ident[6], colors=meta.colors(box=celltype.colors))
mash_plot_meta(m, ident[7], colors=meta.colors(box=celltype.colors))
```
