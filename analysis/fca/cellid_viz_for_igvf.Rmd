---
title: "Cell-ID Validation"
output: html_notebook
---

```{r}
library(Matrix)
library(Matrix.utils)
library(scran)
library(SingleCellExperiment)
library(tidyverse)
library(vroom)
library(caret)
library(CelliD)
library(corrplot)
```

```{r}
# Load subsampled fetal cell atlas data
fca_counts <- readRDS("/project2/gilad/jpopp/ebQTL/data/fca/counts.sampled.rds")
fca_cells <- readRDS("/project2/gilad/jpopp/ebQTL/data/fca/cell_metadata.rds")
fca_genes <- readRDS("/project2/gilad/jpopp/ebQTL/data/fca/gene_metadata.rds") %>%
  mutate_all(as.character)

# Subset cells to those in the subsampled data
fca_cells <- fca_cells %>%
  filter(sample %in% colnames(fca_counts))

# Subset genes to protein-coding genes without duplicated HGNC entries
pull_gene_type <- function(attr) {
  str_split(attr, "\"")[[1]][6]
}
pull_gene_name <- function(attr) {
  str_split(attr, "\"")[[1]][8]
}
pull_gene_id <- function(attr) {
  str_split(attr, "\"")[[1]][2]
}

gencode <- vroom("/project2/gilad/kenneth/References/human/cellranger/cellranger4.0/refdata-gex-GRCh38-2020-A/genes/genes.gtf", 
                 col_names=c("seqname", "source", "feature", "start", "end", "score", "strand", "frame", "attribute"), skip=5) %>%
  filter(seqname %in% paste0("chr", seq(1, 22))) %>%
  filter(feature == "gene") %>%
  mutate(type=map_chr(attribute, pull_gene_type)) %>%
  mutate(ensg=map_chr(attribute, pull_gene_id)) %>%
  mutate(hgnc=map_chr(attribute, pull_gene_name)) %>%
  filter(type=="protein_coding")

fca_genes <- mutate(fca_genes, gene_id_short=str_extract(gene_id, "[^.]+"))
fca_pc_genes <- filter(fca_genes, 
                       (gene_short_name %in% gencode$hgnc) & (gene_id_short %in% gencode$ensg))
hgnc_duplicates <- fca_pc_genes %>%
  group_by(gene_short_name) %>%
  count() %>%
  filter(n > 1) %>%
  pull(gene_short_name)
fca_pc_genes <- fca_pc_genes %>%
  filter(!gene_short_name %in% hgnc_duplicates)

# Make the counts matrix match the metadata
fca_counts <- fca_counts[fca_pc_genes$gene_id,fca_cells$sample]
rownames(fca_counts) <- fca_pc_genes$gene_short_name
```

```{r}
fca <- SingleCellExperiment(list(counts=fca_counts),
                            colData=fca_cells)
saveRDS(fca, "/project2/gilad/jpopp/ebQTL/data/fca/counts.sampled.sce")
```

Now, just as the original paper subsampled each (organ, cell type) to have at most 5K cells,
we want to do the same with the major cell types (not organ). Otherwise cell types like vascular
endothelial cells which were collected from multiple organs are way over-represented.

First, however, I'm going to remove placental cells and uncharacterized cell types 
which were very similar to a characterized cell type, or were likely contamination
```{r}
fca$celltype <- str_extract(fca$Organ_cell_lineage, "[^-]+$")
omitted_types <- c("AFP_ALB positive cells",
                   "CCL19_CCL21 positive cells",
                   "CLC_IL5RA positive cells",
                   "CSH1_CSH2 positive cells",
                   "ELF3_AGBL2 positive cells",
                   "MUC13_DMBT1 positive cells",
                   "PDE11A_FAM19A2 positive cells",
                   "PDE1C_ACSM3 positive cells",
                   "SATB2_LRRC7 positive cells",
                   "SKOR2_NPSR1 positive cells",
                   "SLC24A4_PEX5L positive cells",
                   "SLC26A4_PAEP positive cells")

celltype_sampler <- as_tibble(colData(fca)) %>%
  select(sample, Organ, celltype) %>%
  mutate(celltype_revised=celltype) %>%
  mutate(celltype_revised=if_else(Organ=="Placenta", true=NA_character_, false=celltype_revised)) %>%
  mutate(celltype_revised=if_else(celltype %in% omitted_types, true=NA_character_, false=celltype_revised)) %>%
  drop_na() %>%
  mutate(celltype=celltype_revised, .keep="unused") %>%
  group_by(celltype) %>%
  add_count(celltype)
```

Now, since we're training a classifier, I am going to remove cell types with fewer than 500 cells which 
may not offer enough information to obtain reliable expression signatures.
```{r}
celltype_sampler %>%
  filter(n < 500) %>%
  select(celltype) %>% 
  unique()
celltype_sampler <- celltype_sampler %>%
  filter(n >= 500)
```

With these rarer cell types removed, we'll subsample the more common cell types to 5K cells
```{r}
keepers_rare <- celltype_sampler %>%
  filter(n <= 5000) %>%
  pull(sample)
keepers_sampled <- celltype_sampler %>%
  filter(n > 5000) %>%
  slice_sample(n=5000) %>%
  pull(sample)
fca <- fca[,c(keepers_rare, keepers_sampled)]
```

Now, I'll perform scran normalization and dimensionality reduction
```{r}
libs <- librarySizeFactors(fca)
sizeFactors(fca) <- libs
fca <- logNormCounts(fca)

fca.dec <- modelGeneVar(fca)
hvg.fca <- getTopHVGs(fca.dec, fdr.threshold=0.1)

fca.pca <- prcomp(t(logcounts(fca)[hvg.fca,]), rank=50)
reducedDims(fca) <- list(PCA=fca.pca$x)

fca <- RunMCA(fca, nmcs=50, features=hvg.fca)
saveRDS(fca, "/project2/gilad/jpopp/ebQTL/data/fca/counts.sampled.mca_pca_fromhvgs.sce")
```

This gives us a list of 56 major cell types, are those appropriate to use for a new classifier?

To look into this, I'm going to test the classifier by trying to annotate the original dataset
```{r}
fca <- readRDS("/project2/gilad/jpopp/ebQTL/data/benchmark_annotation/counts.sampled.mca_pca_fromhvgs.sce")
fca_signatures <- GetGroupGeneSet(fca, group.by="celltype", n.features=100)

cellid_enrichments <- RunCellHGT(fca, pathways = fca_signatures, features=hvg.fca, dims = 1:50, n.features=100)

cellid_labels <- rownames(cellid_enrichments)[apply(cellid_enrichments, 2, which.max)]
cellid_labels <- ifelse(apply(cellid_enrichments, 2, max)>2, yes = cellid_labels, "unassigned") #6 unassigned cells here

major_types <- c(unique(colData(fca)$celltype), "unassigned")
confusion <- confusionMatrix(data=factor(cellid_labels, levels=major_types), reference = factor(colData(fca)$celltype, levels=major_types))
```

```{r, fig.width=10, fig.height=8}
corrplot(confusion$table, is.corr=F, tl.pos='lt', tl.cex=0.75, method='color')
```

This is pretty good performance, although some cell types are driving confusion. 

To understand which cell types are most similar or distinct, I'm going to look into the overlap
between signature gene sets.
```{r fig.width=10, fig.height=8}
celltypes <- unique(names(fca_signatures))
ct_dists <- matrix(nrow=length(celltypes), ncol=length(celltypes))
rownames(ct_dists) <- celltypes
colnames(ct_dists) <- celltypes
for (ct1 in seq_len(length(celltypes))) {
  for (ct2 in seq_len(length(celltypes))) {
    ct_dists[ct1, ct2] = 100 - length(intersect(fca_signatures[[ct1]], fca_signatures[[ct2]]))
  }
}
hc <- hclust(as.dist(ct_dists))
plot(hc, cex=0.8)
```

This calls for another round of merging cells based on function and gene set similarity

### Consolidation in nervous system cells
First, I'll consolidate the nervous system cells into a few groups: CNS neurons, CNS glia,
PNS neurons, PNS glia, eye, and neuroendocrine
```{r}
cns_neuronal_types <- c("Limbic system neurons", "Inhibitory interneurons",
                        "Inhibitory neurons", "Excitatory neurons",
                        "Unipolar brush cells", "Granule neurons", 
                        "Purkinje neurons")
cns_glial_types <- c("Microglia", "Astrocytes", "Oligodendrocytes")
pns_neuronal_types <- c("Visceral neurons", "ENS neurons")
pns_glial_types <- c("ENS glia", "Satellite cells", "Schwann cells")
eye_types <- c("Retinal progenitors and Muller glia", "Amacrine cells",
                   "Bipolar cells", "Ganglion cells", "Retinal pigment cells",
                   "Horizontal cells", "Photoreceptor cells")
neuroendocrine_types <- c("Chromaffin cells", "Islet endocrine cells",
                          "Neuroendocrine cells", "Sympathoblasts")

celltype_sampler <- celltype_sampler %>%
  mutate(celltype=if_else(celltype %in% cns_neuronal_types, true="CNS neurons", false=celltype)) %>%
  mutate(celltype=if_else(celltype %in% cns_glial_types, true="CNS glia", false=celltype)) %>%
  mutate(celltype=if_else(celltype %in% pns_neuronal_types, true="PNS neurons", false=celltype)) %>%
  mutate(celltype=if_else(celltype %in% pns_glial_types, true="PNS glia", false=celltype)) %>%
  mutate(celltype=if_else(celltype %in% eye_types, true="Eye cells", false=celltype)) %>%
  mutate(celltype=if_else(celltype %in% neuroendocrine_types, true="Neuroendocrine cells", false=celltype))
```

### Consolidation of immune cells
Now, for immune cells. I'm going to remove both myeloid cells and hematopoietic stem/ progenitor cells 
since they're ancestors of other cell types that are present here. I'll also lump thymocytes under lymphoid cells
since they're functionally very similar.
```{r}
celltype_sampler <- celltype_sampler %>%
  mutate(celltype=if_else(celltype %in% c("Myeloid cells", "Hematopoietic stem cells"), true=NA_character_, false=celltype)) %>%
  mutate(celltype=if_else(celltype == "Thymocytes", true="Lymphoid cells", false=celltype)) %>%
  drop_na()
```

Now, I need to update the dataset to contain even samples from these groups
```{r}
celltype_subsetter <- celltype_sampler %>%
  select(-n) %>%
  group_by(celltype) %>%
  add_count(celltype)
keepers_rare <- celltype_subsetter %>%
  filter(n <= 5000) %>%
  pull(sample)
keepers_sampled <- celltype_subsetter %>%
  filter(n > 5000) %>%
  slice_sample(n=5000) %>%
  pull(sample)
celltype_subsetter <- celltype_subsetter %>%
  filter(sample %in% c(keepers_rare, keepers_sampled))
```

Now, I'll do the same thing to validate a classifier based on these revised cell types
```{r}
fca_subsampled <- fca[,celltype_subsetter$sample]
fca_subsampled$celltype <- celltype_subsetter$celltype

fca_subsampled.dec <- modelGeneVar(fca_subsampled)
hvg.fca_subsampled <- getTopHVGs(fca_subsampled.dec, fdr.threshold=0.1)

fca_subsampled.pca <- prcomp(t(logcounts(fca_subsampled)[hvg.fca_subsampled,]), rank=50)
reducedDims(fca_subsampled) <- list(PCA=fca_subsampled.pca$x)

fca_subsampled <- RunMCA(fca_subsampled, nmcs=50, features=hvg.fca_subsampled)
```

Check the performance of a Cell ID classifier on the dataset it came from (FCA)
```{r fig.width=10, fig.height=8}
# new_signatures <- GetGroupGeneSet(fca_subsampled, group.by="celltype", n.features=100)

new_cellid_enrichments <- RunCellHGT(fca_subsampled, pathways = new_signatures, features=hvg.fca_subsampled, dims = 1:50, n.features=100)

new_cellid_labels <- rownames(new_cellid_enrichments)[apply(new_cellid_enrichments, 2, which.max)]
new_cellid_labels <- ifelse(apply(new_cellid_enrichments, 2, max)>2, yes = new_cellid_labels, "unassigned") #3 unassigned cells here

celltypes_remaining <- c(unique(colData(fca_subsampled)$celltype), "unassigned")
new_confusion <- confusionMatrix(data=factor(new_cellid_labels, levels=celltypes_remaining), 
                                 reference = factor(colData(fca_subsampled)$celltype, levels=celltypes_remaining))

corrplot(new_confusion$table, is.corr=F, tl.pos='lt', tl.cex=0.75, method='color')
```


Cell type tree
```{r}
mca.embedding.subsampled <- reducedDim(fca_subsampled, "MCA")
new_celltype_centroids <- aggregate.Matrix(mca.embedding.subsampled, groupings=fca_subsampled$celltype, fun="mean")

new_dists <- dist(new_celltype_centroids)
hc <- hclust(new_dists)
plot(hc, cex=0.8)
```

# Visualize MC space
```{r}
emb <- as_tibble(reducedDim(fca_subsampled, "MCA"), rownames="sample") %>%
  left_join(as_tibble(colData(fca_subsampled)), by="sample") 
centroids <- as_tibble(as.matrix(new_celltype_centroids), rownames="celltype")
emb_subset <- select(emb, c(MCA_1, MCA_2, celltype)) %>%
  group_by(celltype) %>%
  sample_n(500)

gene_emb <- attributes(emb$MCA_1)$genesCoordinates
marker_genes <- c("ALB", "TNNT2", "MAP1B")
marker_emb <- gene_emb[marker_genes,] %>%
  as_tibble(rownames="gene")
```


```{r, fig.width=25, fig.height=10}
nice_centroids <- filter(centroids, celltype %in% c("Hepatoblasts", "Cardiomyocytes", "Skeletal muscle cells", "CNS neurons", "PNS neurons", "Retinal cells"))

ggplot(emb_subset, aes(x=MCA_1, y=MCA_2)) +
  geom_point(aes(color=celltype)) +
  geom_label(data=nice_centroids, aes(label=celltype, color=celltype), size=8, position=position_jitter(width=0.25, height=0.25, seed=12)) +
  geom_label(data=marker_emb, aes(label=gene), size=8, position=position_jitter(width=0.25, height=0.25, seed=12)) +
  theme_classic(base_size = 25)
```


# Visualize distance in terms of hamming distance between cell types
```{r}
celltypes <- unique(names(new_signatures))
ct_dists <- matrix(nrow=length(celltypes), ncol=length(celltypes))
rownames(ct_dists) <- celltypes
colnames(ct_dists) <- celltypes
for (ct1 in seq_len(length(celltypes))) {
  for (ct2 in seq_len(length(celltypes))) {
    ct_dists[ct1, ct2] = 100 - length(intersect(new_signatures[[ct1]], new_signatures[[ct2]]))
  }
}
hc <- hclust(as.dist(ct_dists), method="average")
plot(hc, cex=0.8)
```

# Save cell type signatures, highly variable genes, and our filtered object
```{r}
saveRDS(fca_subsampled, "/project2/gilad/jpopp/ebQTL/data/fca/counts.subsampled.mca_pca_fromhvgs.sce")
save(new_signatures, hvg.fca_subsampled, file="/project2/gilad/jpopp/ebQTL/data/fca/cellid_signatures_and_hvgs.Rdata")
```

## View distances to centroid
```{r}
fca_subsampled <- readRDS("/project2/gilad/jpopp/ebQTL/data/fca/counts.subsampled.mca_pca_fromhvgs.sce")
load("/project2/gilad/jpopp/ebQTL/data/fca/cellid_signatures_and_hvgs.Rdata")

emb <- as_tibble(reducedDim(fca_subsampled, "MCA"), rownames="sample") %>%
  left_join(as_tibble(colData(fca_subsampled)), by="sample") 
gene_emb <- attributes(emb$MCA_1)$genesCoordinates
```

### Cardiomyocytes
First, an example cell type, cardiomyocytes
```{r}
cm <- fca_subsampled[,fca_subsampled$celltype=="Cardiomyocytes"]
```

Distance of each cell to centroid
```{r}
mca_cm <- reducedDim(cm, "MCA")
centroid_cm <- apply(mca_cm, 2, mean)
cell_dists <- apply(mca_cm - centroid_cm, 1, norm, type="2")
hist(cell_dists)
```

Distance of each marker gene to centroid
```{r}
markers_cm <- gene_emb[new_signatures$Cardiomyocytes,]
gene_dists <- apply(markers_cm - centroid_cm, 1, norm, type="2")
hist(gene_dists)
```

### Erythroblasts
```{r}
rbc <- fca_subsampled[,fca_subsampled$celltype=="Erythroblasts"]
```

```{r}
mca_rbc <- reducedDim(rbc, "MCA")
centroid_rbc <- apply(mca_rbc, 2, mean)
cell_dists_rbc <- apply(mca_rbc - centroid_rbc, 1, norm, type="2")
hist(cell_dists_rbc)
```

```{r}
markers_rbc <- gene_emb[new_signatures$Erythroblasts,]
gene_dists_rbc <- apply(markers_rbc - centroid_rbc, 1, norm, type="2")
hist(gene_dists_rbc)
```



