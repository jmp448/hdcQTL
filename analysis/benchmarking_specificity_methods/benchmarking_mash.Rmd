```{r}
library(tidyverse)
library(mashr)
```

First, there are some normalization decisions that only come into play when we start looking across cell types.

Does it matter whether we apply TMM normalization across all cell types the same way, or within each cell type separately?

Does it matter whether we normalize genotypes?
```{r}
load("results/benchmark_specificity_methods/eb_cellid/pseudobulk_tmm/tmmtype/8pcs/tensorqtlbasic_mash_corr_eval.Rdata")
m.tmmtype.tensorqtlbasic.orig.test <- m.orig.test
ll.tmmtype.tensorqtlbasic.orig <- get_loglik(m.tmmtype.tensorqtlbasic.orig.test)

m.tmmtype.tensorqtlbasic.Vsimple.test <- m.Vsimple.test
ll.tmmtype.tensorqtlbasic.Vsimple <- get_loglik(m.tmmtype.tensorqtlbasic.Vsimple.test)

m.tmmtype.tensorqtlbasic.Vem.test <- m.Vem.test
ll.tmmtype.tensorqtlbasic.Vem <- get_loglik(m.tmmtype.tensorqtlbasic.Vem.test)

load("results/benchmark_specificity_methods/eb_cellid/pseudobulk_tmm/tmmtype/8pcs/tensorqtlgenonorm_mash_corr_eval.Rdata")
m.tmmtype.tensorqtlgenonorm.orig.test <- m.orig.test
ll.tmmtype.tensorqtlgenonorm.orig <- get_loglik(m.tmmtype.tensorqtlgenonorm.orig.test)

m.tmmtype.tensorqtlgenonorm.Vsimple.test <- m.Vsimple.test
ll.tmmtype.tensorqtlgenonorm.Vsimple <- get_loglik(m.tmmtype.tensorqtlgenonorm.Vsimple.test)

m.tmmtype.tensorqtlgenonorm.Vem.test <- m.Vem.test
ll.tmmtype.tensorqtlgenonorm.Vem <- get_loglik(m.tmmtype.tensorqtlgenonorm.Vem.test)

load("results/benchmark_specificity_methods/eb_cellid/pseudobulk_tmm/tmmall/8pcs/tensorqtlbasic_mash_corr_eval.Rdata")
m.tmmall.tensorqtlbasic.orig.test <- m.orig.test
ll.tmmall.tensorqtlbasic.orig <- get_loglik(m.tmmall.tensorqtlbasic.orig.test)

m.tmmall.tensorqtlbasic.Vsimple.test <- m.Vsimple.test
ll.tmmall.tensorqtlbasic.Vsimple <- get_loglik(m.tmmall.tensorqtlbasic.Vsimple.test)

m.tmmall.tensorqtlbasic.Vem.test <- m.Vem.test
ll.tmmall.tensorqtlbasic.Vem <- get_loglik(m.tmmall.tensorqtlbasic.Vem.test)

load("results/benchmark_specificity_methods/eb_cellid/pseudobulk_tmm/tmmall/8pcs/tensorqtlgenonorm_mash_corr_eval.Rdata")
m.tmmall.tensorqtlgenonorm.orig.test <- m.orig.test
ll.tmmall.tensorqtlgenonorm.orig <- get_loglik(m.tmmall.tensorqtlgenonorm.orig.test)

m.tmmall.tensorqtlgenonorm.Vsimple.test <- m.Vsimple.test
ll.tmmall.tensorqtlgenonorm.Vsimple <- get_loglik(m.tmmall.tensorqtlgenonorm.Vsimple.test)

m.tmmall.tensorqtlgenonorm.Vem.test <- m.Vem.test
ll.tmmall.tensorqtlgenonorm.Vem <- get_loglik(m.tmmall.tensorqtlgenonorm.Vem.test)
```

```{r}
tibble("exp_norm"=rep(c("tmmtype", "tmmall"), each=6),
       "geno_norm"=rep(c("dosage", "normalized", "dosage", "normalized"), each=3),
       "correlation"=rep(c("none", "simple", "EM"), times=4),
       "loglik"=c(ll.tmmtype.tensorqtlbasic.orig, ll.tmmtype.tensorqtlbasic.Vsimple, ll.tmmtype.tensorqtlbasic.Vem,
                  ll.tmmtype.tensorqtlgenonorm.orig, ll.tmmtype.tensorqtlgenonorm.Vsimple, ll.tmmtype.tensorqtlgenonorm.Vem,
                  ll.tmmall.tensorqtlbasic.orig, ll.tmmall.tensorqtlbasic.Vsimple, ll.tmmall.tensorqtlbasic.Vem,
                  ll.tmmall.tensorqtlgenonorm.orig, ll.tmmall.tensorqtlgenonorm.Vsimple, ll.tmmall.tensorqtlgenonorm.Vem)) %>%
  mutate(exp_norm=factor(exp_norm, levels=c("tmmtype", "tmmall"))) %>%
  mutate(geno_norm=factor(geno_norm, levels=c("dosage", "normalized"))) %>%
  mutate(correlation=factor(correlation, levels=c("none", "simple", "EM"))) %>%
  ggplot(aes(x=geno_norm, y=loglik, fill=correlation)) +
    geom_col(position=position_dodge()) +
    facet_grid(rows=vars(exp_norm)) +
    xlab("Genotype Normalization Method") +
    ylab("Log Likelihood")
```
Genotype normalization is huge, and should definitely be implemented. Expression normalization and correlation
estimation are much less impactful, but separate TMM normalization in each cell type 
seems to work better, as does using EM to estimate correlation structure

### Comparing pi
The difference must be in the estimates of pi, right? What's the big difference?
```{r}
normalized <- as_tibble(m.tmmtype.tensorqtlgenonorm.orig.test$fitted_g$pi, rownames="component") %>%
  mutate(component=str_extract(component, "[^.]+")) %>%
  group_by(component) %>%
  summarize(normalized=sum(value))

dosage <- as_tibble(m.tmmtype.tensorqtlbasic.orig.test$fitted_g$pi, rownames="component") %>%
  mutate(component=str_extract(component, "[^.]+")) %>%
  group_by(component) %>%
  summarize(dosage=sum(value))

inner_join(normalized, dosage, by="component") %>%
  pivot_longer(!component, names_to="genotypes", values_to="contribution") %>%
  ggplot(aes(x=component, y=contribution, fill=genotypes)) +
    geom_col(position=position_dodge()) +
    coord_flip()
```

Within the equal effects, are the two distributions notably different?
```{r}
grid_normalized <- as_tibble(m.tmmtype.tensorqtlgenonorm.orig.test$fitted_g$grid, rownames="id") %>%
  rename(width=value)
ee_normalized <- as_tibble(m.tmmtype.tensorqtlgenonorm.orig.test$fitted_g$pi, rownames="factor") %>%
  mutate(component=str_extract(factor, "[^.]+")) %>%
  filter(component=="equal_effects") %>%
  mutate(id=str_extract(factor, "[^.]+$")) %>%
  full_join(grid_normalized, by="id") %>%
  mutate(genotypes="normalized")

grid_dosages <- as_tibble(m.tmmtype.tensorqtlbasic.orig.test$fitted_g$grid, rownames="id") %>%
  rename(width=value)
ee_dosages <- as_tibble(m.tmmtype.tensorqtlbasic.orig.test$fitted_g$pi, rownames="factor") %>%
  mutate(component=str_extract(factor, "[^.]+")) %>%
  filter(component=="equal_effects") %>%
  mutate(id=str_extract(factor, "[^.]+$")) %>%
  full_join(grid_normalized, by="id") %>%
  mutate(genotypes="dosages")

bind_rows(ee_normalized, ee_dosages) %>%
  mutate(width=factor(round(width, 5))) %>%
  ggplot(aes(x=width, y=value, fill=genotypes)) +
  geom_col(position=position_dodge()) +
  theme(axis.text.x=element_text(angle=45, hjust=1))
```
Still doesn't look all that different! Let's look at the distribution of log likelihoods over tests
```{r}
hist(m.tmmtype.tensorqtlbasic.orig.test$vloglik, n=50)
```
```{r}
hist(m.tmmtype.tensorqtlgenonorm.orig.test$vloglik, n=50)
```
Kind of wild that the *median* log likelihood is way higher. Is this true for each context?
```{r}
hist(m.tmmtype.tensorqtlbasic.orig.test$result$NegativeProb[,"Acinar-cells"], n=50)
hist(m.tmmtype.tensorqtlgenonorm.orig.test$result$NegativeProb[,"Acinar-cells"], n=50)
```

```{r}
hist(m.tmmtype.tensorqtlbasic.orig.test$result$NegativeProb[,"Bronchiolar-and-alveolar-epithelial-cells"], n=50)
hist(m.tmmtype.tensorqtlgenonorm.orig.test$result$NegativeProb[,"Bronchiolar-and-alveolar-epithelial-cells"], n=50)
```



## Evaluating alpha
Is there a clear optimal choice of alpha here?
```{r}
load("results/benchmark_specificity_methods/eb_cellid/pseudobulk_tmm/tmmtype/8pcs/tensorqtlgenonorm_mash_alpha_eval.Rdata")

as_tibble(logliks) %>%
  ggplot(aes(x=alpha, y=loglik)) + 
  geom_col()
```
Once again, it's a very subtle difference but it does look like the exchangeable effects model works better

## How to define U
Last, we'll look at whether there's a big difference between using PCA vs SFA vs both, whether it's worthwhile to include ED, and whether it's worthwhile to allow for singleton effects
```{r}
# There's a big difference worth focusing on here - PCA does way better than ED
weight_comparison <- as_tibble(get_estimated_pi(m.default), rownames="component") %>%
  mutate(component=str_replace(component, "ED_", "")) %>%
  inner_join(as_tibble(get_estimated_pi(m.pca), rownames="component"), by="component") %>%
  rename(ED=value.x, PCA=value.y)

weight_comparison %>%
  pivot_longer(!component, names_to="method", values_to="weight") %>%
  ggplot(aes(x=component, y=weight, fill=method)) +
  geom_col(position=position_dodge()) +
  coord_flip() +
  theme_classic(base_size=20)
  
# Visualize PC1
ectoderm_types <- c("CNS-neurons", "CNS-glia", "PNS-neurons", "PNS-glia", 
                    "Retinal-cells", "Adrenocortical-cells", "Neuroendocrine-cells"
)
epithelial_types <- c("Ciliated-epithelial-cells", "Ductal-cells", "Acinar-cells", 
                      "Metanephric-cells", "Ureteric-bud-cells")
endoderm_types <- c("Goblet-cells", "Hepatoblasts", "Parietal-and-chief-cells", 
                    "Bronchiolar-and-alveolar-epithelial-cells", "Squamous-epithelial-cells")
mesoderm_types <- c("Cardiomyocytes", "Stromal-cells", "Epicardial-fat-cells", 
                    "Mesangial-cells", "Smooth-muscle-cells", "Mesothelial-cells",
                    "Stellate-cells" , "Vascular-endothelial-cells", "Skeletal-muscle-cells")
immune_types <- c("Erythroblasts", "Lymphoid-cells", "Megakaryocytes")

type_levels <- c(ectoderm_types, epithelial_types, mesoderm_types, 
                 endoderm_types, immune_types)

as_tibble(princomp(U.pca.default[['PCA_1']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme_classic(base_size=15) +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.pca.default[['PCA_2']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme_classic(base_size=15) +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.pca.default[['PCA_3']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme_classic(base_size=15) +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.pca.default[['PCA_4']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme_classic(base_size=15) +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.pca.default[['PCA_5']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme_classic(base_size=15) +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.ed.default[['ED_PCA_1']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

# Visualize that tPCA component
as_tibble(princomp(U.pca.default[['tPCA']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.ed.default[['ED_tPCA']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")


as_tibble(princomp(U.pca.ez[['PCA_1']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.pca.ez[['tPCA']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

# What do the flash components look like?
as_tibble(princomp(U.flash[['FLASH_default_1']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.flash[['FLASH_default_2']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.flash[['FLASH_default_3']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.flash[['FLASH_default_4']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.flash[['FLASH_default_5']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.flash[['tFLASH_default']])$loadings[,1], rownames="celltype") %>%
  mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

```

```{r}
as_tibble(princomp(U.pca[['PCA_1']])$loadings[,1], rownames="celltype") %>%
  #mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme_classic(base_size=15) +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.pca[['PCA_2']])$loadings[,1], rownames="celltype") %>%
  #mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme_classic(base_size=15) +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.pca[['PCA_3']])$loadings[,1], rownames="celltype") %>%
  #mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme_classic(base_size=15) +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.pca[['PCA_4']])$loadings[,1], rownames="celltype") %>%
  #mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme_classic(base_size=15) +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.pca[['PCA_5']])$loadings[,1], rownames="celltype") %>%
  #mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme_classic(base_size=15) +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

as_tibble(princomp(U.pca[['tPCA']])$loadings[,1], rownames="celltype") %>%
  #mutate(celltype=factor(celltype, levels=type_levels)) %>%
  ggplot(aes(x=celltype, y=value, fill=celltype)) + geom_col() +
  theme_classic(base_size=15) +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")
```