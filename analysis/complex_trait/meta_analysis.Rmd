---
title: "Cross-Trait Meta-Analyses"
output: html_notebook
---
```{r}
library(rmeta)
library(vroom)
library(tidyverse)
```


```{r}
all_trait_info <- vroom("TCSC/sumstats/alltraits.txt")
all_traits <- all_trait_info$Trait_Identifier
```

## MASH Analysis
Load all LDSC results
```{r}
mash_results_loc <- paste0("results/ldsc/baseline_eqtl_gtexpilotcomb_mash-signif_annot/", all_traits, ".results")

pull_trait <- function(s) {
  trait_identifier <- str_sub(tail(str_split(s, "/")[[1]], n=1), 1, -9)
  if (str_sub(trait_identifier, 1, 4) == "PASS") {
    trait <- str_sub(trait_identifier, 6)
  } else if (str_sub(trait_identifier, 1, 8) == "UKB_460K") {
    trait <- str_sub(trait_identifier, 10)
  }
  trait
}

# compile a list of QTL test p-values across all tests
mash_results <- vroom(mash_results_loc, id="path") %>%
  mutate(trait=sapply(path, pull_trait), .keep="unused") 

qtl_mash_results <- filter(mash_results, str_sub(Category, 1, 2) %in% c("EB", "GT")) %>%
  mutate(Category=str_sub(Category, 1, -5)) %>%
  mutate(highlight=Category=="EB")
```

### Individual Trait Analysis
First, view all traits separately. Are the coefficients confidently non-zero?
```{r fig.height=20, fig.width=20}
ggplot(qtl_mash_results, aes(x=factor(Category, levels=c("GTEx_Pilot_eQTL", "EB")), y=Coefficient, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Coefficient - Coefficient_std_error, ymax = Coefficient + Coefficient_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Heritability Explained") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip() +
  facet_wrap(vars(trait))
```

Is the enrichment confidently positive? 
```{r fig.height=20, fig.width=20}
ggplot(qtl_mash_results, aes(x=factor(Category, levels=c("GTEx_Pilot_eQTL", "EB")), y=Enrichment, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Enrichment - Enrichment_std_error, ymax = Enrichment + Enrichment_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Heritability Enrichment") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip() +
  facet_wrap(vars(trait))
```

### Meta-Analysis
Coefficients
```{r}
qtl_mash_results_eb <- filter(qtl_mash_results, Category=="EB")
qtl_mash_results_gtex <- filter(qtl_mash_results, Category=="GTEx_Pilot_eQTL")

meta_coef_eb <- meta.summaries(qtl_mash_results_eb$Coefficient, qtl_mash_results_eb$Coefficient_std_error)
meta_coef_gtex <- meta.summaries(qtl_mash_results_gtex$Coefficient, qtl_mash_results_gtex$Coefficient_std_error)

meta_coefficients <- tibble("Category"=c("EB", "GTEx"), "Coefficient"=c(meta_coef_eb$summary, meta_coef_gtex$summary), 
                            "Coefficient_std_error"=c(meta_coef_eb$se.summary, meta_coef_gtex$se.summary),
                            "highlight"=c(T, F))

ggplot(meta_coefficients, aes(x=factor(Category, levels=c("GTEx", "EB")), y=Coefficient, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Coefficient - Coefficient_std_error, ymax = Coefficient + Coefficient_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Coefficient") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip()
```

Enrichment
```{r}
meta_enrichment_eb <- meta.summaries(qtl_mash_results_eb$Enrichment, qtl_mash_results_eb$Enrichment_std_error)
meta_enrichment_gtex <- meta.summaries(qtl_mash_results_gtex$Enrichment, qtl_mash_results_gtex$Enrichment_std_error)

meta_enrichments <- tibble("Category"=c("EB", "GTEx"), "Enrichment"=c(meta_enrichment_eb$summary, meta_enrichment_gtex$summary), 
                            "Enrichment_std_error"=c(meta_enrichment_eb$se.summary, meta_enrichment_gtex$se.summary),
                            "highlight"=c(T, F))

ggplot(meta_enrichments, aes(x=factor(Category, levels=c("GTEx", "EB")), y=Enrichment, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Enrichment - Enrichment_std_error, ymax = Enrichment + Enrichment_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Heritability Enrichment") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip()
```


## Non-MASH Analysis
Load all LDSC results
```{r}
perm_results_loc <- paste0("results/ldsc/baseline_eqtl_gtexpilotcomb_signif_annot/", all_traits, ".results")

pull_trait <- function(s) {
  trait_identifier <- str_sub(tail(str_split(s, "/")[[1]], n=1), 1, -9)
  if (str_sub(trait_identifier, 1, 4) == "PASS") {
    trait <- str_sub(trait_identifier, 6)
  } else if (str_sub(trait_identifier, 1, 8) == "UKB_460K") {
    trait <- str_sub(trait_identifier, 10)
  }
  trait
}

# compile a list of QTL test p-values across all tests
perm_results <- vroom(perm_results_loc, id="path") %>%
  mutate(trait=sapply(path, pull_trait), .keep="unused") 

qtl_perm_results <- filter(perm_results, str_sub(Category, 1, 2) %in% c("EB", "GT")) %>%
  mutate(Category=str_sub(Category, 1, -5)) %>%
  mutate(highlight=Category=="EB")
```

First, view all traits separately
```{r fig.height=20, fig.width=20}
ggplot(qtl_perm_results, aes(x=factor(Category, levels=c("GTEx_Pilot_eQTL", "EB")), y=Coefficient, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Coefficient - Coefficient_std_error, ymax = Coefficient + Coefficient_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Heritability Explained") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip() +
  facet_wrap(vars(trait))
```

Is the enrichment confidently positive? 
```{r fig.height=20, fig.width=20}
ggplot(qtl_perm_results, aes(x=factor(Category, levels=c("GTEx_Pilot_eQTL", "EB")), y=Enrichment, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Enrichment - Enrichment_std_error, ymax = Enrichment + Enrichment_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Heritability Enrichment") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip() +
  facet_wrap(vars(trait))
```

### Meta-Analysis
Coefficients
```{r}
qtl_perm_results_eb <- filter(qtl_perm_results, Category=="EB")
qtl_perm_results_gtex <- filter(qtl_perm_results, Category=="GTEx_Pilot_eQTL")

meta_coef_eb_perm <- meta.summaries(qtl_perm_results_eb$Coefficient, qtl_perm_results_eb$Coefficient_std_error)
meta_coef_gtex_perm <- meta.summaries(qtl_perm_results_gtex$Coefficient, qtl_perm_results_gtex$Coefficient_std_error)

meta_coefficients_perm <- tibble("Category"=c("EB", "GTEx"), "Coefficient"=c(meta_coef_eb_perm$summary, meta_coef_gtex_perm$summary), 
                            "Coefficient_std_error"=c(meta_coef_eb_perm$se.summary, meta_coef_gtex_perm$se.summary),
                            "highlight"=c(T, F))

ggplot(meta_coefficients_perm, aes(x=factor(Category, levels=c("GTEx", "EB")), y=Coefficient, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Coefficient - Coefficient_std_error, ymax = Coefficient + Coefficient_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Coefficient") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip()
```

Enrichment
```{r}
meta_enrichment_eb_perm <- meta.summaries(qtl_perm_results_eb$Enrichment, qtl_perm_results_eb$Enrichment_std_error)
meta_enrichment_gtex_perm <- meta.summaries(qtl_perm_results_gtex$Enrichment, qtl_perm_results_gtex$Enrichment_std_error)

meta_enrichments_perm <- tibble("Category"=c("EB", "GTEx"), "Enrichment"=c(meta_enrichment_eb_perm$summary, meta_enrichment_gtex_perm$summary), 
                            "Enrichment_std_error"=c(meta_enrichment_eb_perm$se.summary, meta_enrichment_gtex_perm$se.summary),
                            "highlight"=c(T, F))

ggplot(meta_enrichments_perm, aes(x=factor(Category, levels=c("GTEx", "EB")), y=Enrichment, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Enrichment - Enrichment_std_error, ymax = Enrichment + Enrichment_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Heritability Enrichment") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip()
```

# Looking at disease-relevant gene sets
## MASH Analysis
Load all LDSC results
```{r}
mash_results_loc <- paste0("results/ldsc/baseline_geneset_GOBP-TISSUE-DEV_full_gtexcomb_mash-signif_annot/", all_traits, ".results")

pull_trait <- function(s) {
  trait_identifier <- str_sub(tail(str_split(s, "/")[[1]], n=1), 1, -9)
  if (str_sub(trait_identifier, 1, 4) == "PASS") {
    trait <- str_sub(trait_identifier, 6)
  } else if (str_sub(trait_identifier, 1, 8) == "UKB_460K") {
    trait <- str_sub(trait_identifier, 10)
  }
  trait
}

# compile a list of QTL test p-values across all tests
mash_results <- vroom(mash_results_loc, id="path") %>%
  mutate(trait=sapply(path, pull_trait), .keep="unused") 

qtl_mash_results <- filter(mash_results, str_sub(Category, 1, 2) %in% c("EB", "GT")) %>%
  mutate(Category=str_sub(Category, 1, -5)) %>%
  mutate(highlight=Category=="EB")
```

### Individual Trait Analysis
First, view all traits separately. Are the coefficients confidently non-zero?
```{r fig.height=20, fig.width=20}
ggplot(qtl_mash_results, aes(x=factor(Category, levels=c("GTEx_Pilot_eQTL", "EB")), y=Coefficient, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Coefficient - Coefficient_std_error, ymax = Coefficient + Coefficient_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Heritability Explained") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip() +
  facet_wrap(vars(trait))
```

Is the enrichment confidently positive? 
```{r fig.height=20, fig.width=20}
ggplot(qtl_mash_results, aes(x=factor(Category, levels=c("GTEx_Pilot_eQTL", "EB")), y=Enrichment, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Enrichment - Enrichment_std_error, ymax = Enrichment + Enrichment_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Heritability Enrichment") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip() +
  facet_wrap(vars(trait))
```

### Meta-Analysis
```{r}
qtl_mash_results_eb <- filter(qtl_mash_results, Category=="EB")
qtl_mash_results_gtex <- filter(qtl_mash_results, Category=="GTEx_eQTL")

meta_coef_eb_mash <- meta.summaries(qtl_mash_results_eb$Coefficient, qtl_mash_results_eb$Coefficient_std_error)
meta_coef_gtex_mash <- meta.summaries(qtl_mash_results_gtex$Coefficient, qtl_mash_results_gtex$Coefficient_std_error)

meta_coefficients_mash <- tibble("Category"=c("EB", "GTEx"), "Coefficient"=c(meta_coef_eb_mash$summary, meta_coef_gtex_mash$summary), 
                            "Coefficient_std_error"=c(meta_coef_eb_mash$se.summary, meta_coef_gtex_mash$se.summary),
                            "highlight"=c(T, F))

ggplot(meta_coefficients_mash, aes(x=factor(Category, levels=c("GTEx", "EB")), y=Coefficient, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Coefficient - Coefficient_std_error, ymax = Coefficient + Coefficient_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Coefficient") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip()
```

```{r}
meta_enrichment_eb <- meta.summaries(qtl_mash_results_eb$Enrichment, qtl_mash_results_eb$Enrichment_std_error)
meta_enrichment_gtex <- meta.summaries(qtl_mash_results_gtex$Enrichment, qtl_mash_results_gtex$Enrichment_std_error)

meta_enrichments <- tibble("Category"=c("EB", "GTEx"), "Enrichment"=c(meta_enrichment_eb$summary, meta_enrichment_gtex$summary), 
                            "Enrichment_std_error"=c(meta_enrichment_eb$se.summary, meta_enrichment_gtex$se.summary),
                            "highlight"=c(T, F))

ggplot(meta_enrichments, aes(x=factor(Category, levels=c("GTEx", "EB")), y=Enrichment, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Enrichment - Enrichment_std_error, ymax = Enrichment + Enrichment_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Heritability Enrichment") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip()
```

## Permutation Analysis
Load all LDSC results
```{r}
perm_results_loc <- paste0("results/ldsc/baseline_geneset_GOBP-TISSUE-DEV_full_gtexcomb_signif_annot/", all_traits, ".results")

pull_trait <- function(s) {
  trait_identifier <- str_sub(tail(str_split(s, "/")[[1]], n=1), 1, -9)
  if (str_sub(trait_identifier, 1, 4) == "PASS") {
    trait <- str_sub(trait_identifier, 6)
  } else if (str_sub(trait_identifier, 1, 8) == "UKB_460K") {
    trait <- str_sub(trait_identifier, 10)
  }
  trait
}

# compile a list of QTL test p-values across all tests
perm_results <- vroom(perm_results_loc, id="path") %>%
  mutate(trait=sapply(path, pull_trait), .keep="unused") 

qtl_perm_results <- filter(perm_results, str_sub(Category, 1, 2) %in% c("EB", "GT")) %>%
  mutate(Category=str_sub(Category, 1, -5)) %>%
  mutate(highlight=Category=="EB")
```

### Individual Trait Analysis
First, view all traits separately. Are the coefficients confidently non-zero?
```{r fig.height=20, fig.width=20}
ggplot(qtl_perm_results, aes(x=factor(Category, levels=c("GTEx_Pilot_eQTL", "EB")), y=Coefficient, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Coefficient - Coefficient_std_error, ymax = Coefficient + Coefficient_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Heritability Explained") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip() +
  facet_wrap(vars(trait))
```

Is the enrichment confidently positive? 
```{r fig.height=20, fig.width=20}
ggplot(qtl_perm_results, aes(x=factor(Category, levels=c("GTEx_Pilot_eQTL", "EB")), y=Enrichment, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Enrichment - Enrichment_std_error, ymax = Enrichment + Enrichment_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Heritability Enrichment") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip() +
  facet_wrap(vars(trait))
```

### Meta-Analysis
```{r}
qtl_perm_results_eb <- filter(qtl_perm_results, Category=="EB")
qtl_perm_results_gtex <- filter(qtl_perm_results, Category=="GTEx_eQTL")

meta_coef_eb_perm <- meta.summaries(qtl_perm_results_eb$Coefficient, qtl_perm_results_eb$Coefficient_std_error)
meta_coef_gtex_perm <- meta.summaries(qtl_perm_results_gtex$Coefficient, qtl_perm_results_gtex$Coefficient_std_error)

meta_coefficients_perm <- tibble("Category"=c("EB", "GTEx"), "Coefficient"=c(meta_coef_eb_perm$summary, meta_coef_gtex_perm$summary), 
                            "Coefficient_std_error"=c(meta_coef_eb_perm$se.summary, meta_coef_gtex_perm$se.summary),
                            "highlight"=c(T, F))

ggplot(meta_coefficients_perm, aes(x=factor(Category, levels=c("GTEx", "EB")), y=Coefficient, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Coefficient - Coefficient_std_error, ymax = Coefficient + Coefficient_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Coefficient") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip()
```

```{r}
meta_enrichment_eb <- meta.summaries(qtl_perm_results_eb$Enrichment, qtl_perm_results_eb$Enrichment_std_error)
meta_enrichment_gtex <- meta.summaries(qtl_perm_results_gtex$Enrichment, qtl_perm_results_gtex$Enrichment_std_error)

meta_enrichments <- tibble("Category"=c("EB", "GTEx"), "Enrichment"=c(meta_enrichment_eb$summary, meta_enrichment_gtex$summary), 
                            "Enrichment_std_error"=c(meta_enrichment_eb$se.summary, meta_enrichment_gtex$se.summary),
                            "highlight"=c(T, F))

ggplot(meta_enrichments, aes(x=factor(Category, levels=c("GTEx", "EB")), y=Enrichment, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Enrichment - Enrichment_std_error, ymax = Enrichment + Enrichment_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Heritability Enrichment") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip()
```

## Focus on schizophrenia
```{r}
scz_mash_results <- filter(qtl_mash_results, trait == "Schizophrenia_Pardinas2018")
ggplot(scz_mash_results, aes(x=factor(Category, levels=c("GTEx_eQTL", "EB")), y=Coefficient, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Coefficient - Coefficient_std_error, ymax = Coefficient + Coefficient_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = bquote(paste("Coefficient ", tau))) +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip()

ggplot(scz_mash_results, aes(x=factor(Category, levels=c("GTEx_eQTL", "EB")), y=Enrichment, fill=highlight)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Enrichment - Enrichment_std_error, ymax = Enrichment + Enrichment_std_error), position = position_dodge(width = 0.9), width = 0.25) +
  geom_hline(yintercept=0, linetype="dashed") +
  scale_fill_manual(values=c("#BBBBBB", "#B51700")) +
  labs(x = "Tissue",
       y = "Heritability Enrichment") +
  theme_classic(base_size=20) +
  theme(legend.position = "none") +
  coord_flip()
```

