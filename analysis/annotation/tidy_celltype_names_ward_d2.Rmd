```{r}
library(tidyverse)
library(SingleCellExperiment)
library(Matrix)
library(Matrix.utils)
library(corrplot)
library(gplots)
library(edgeR)
library(dendextend)
library(vroom)
```

```{r fig.height=6, fig.width=6}
eb_pseudobulk_counts <- vroom("data/static_qtl_calling/eb_cellid/pseudobulk_tmm/basic/pseudobulk_all.tsv") %>%
  column_to_rownames("gene") %>% t %>% as("dgCMatrix")

eb_pseudobulk_counts_agg <- aggregate.Matrix(eb_pseudobulk_counts, 
                                             groupings=str_extract(rownames(eb_pseudobulk_counts), "[^_]+$"), 
                                             fun="sum")

gtf_pcgs <- vroom("data/gencode/gencode.hg38.filtered.gtf")
pcgs <- gtf_pcgs$hgnc
hvgs <- read_tsv("data/fca/fca_subsampled_hvg.tsv")

keeper_genes <- intersect(intersect(colnames(eb_pseudobulk_counts_agg), pcgs), hvgs$gene)
eb_pseudobulk_counts_agg <- eb_pseudobulk_counts_agg[,keeper_genes]
eb_pseudobulk_norm <- DGEList(counts=t(eb_pseudobulk_counts_agg)) %>% 
  calcNormFactors(method="TMM") %>% 
  edgeR::cpm(log=T)

hierarchical_clustering <- hclust(dist(t(eb_pseudobulk_norm)), method="ward.D")
plot(hierarchical_clustering)

type_order <- hierarchical_clustering$labels[hierarchical_clustering$order]
```

```{r}
avg_dend_obj <- as.dendrogram(hierarchical_clustering)
avg_col_dend <- color_branches(avg_dend_obj, col=c("#004D80", "#00AB8E", "#0076BA", "#B51700", "#FEAE00", "#965C3D", "#970E53"), h = 125)
plot(avg_col_dend)
```
```{r fig.height=4, fig.width=6}
rotated_order <- c("Neuroendocrine-cells", "PNS-neurons", "Skeletal-muscle-cells",                               
                   "PNS-glia", "CNS-neurons" , "Retinal-cells", "CNS-glia",
                   "Metanephric-cells", "Erythroblasts", "Ciliated-epithelial-cells",
                   "Acinar-cells", "Ductal-cells", "Bronchiolar-and-alveolar-epithelial-cells", "Adrenocortical-cells",
                   "Parietal-and-chief-cells", "Ureteric-bud-cells",
                   "Epicardial-fat-cells", "Mesothelial-cells", "Cardiomyocytes", "Mesangial-cells",
                   "Stellate-cells", "Smooth-muscle-cells", "Stromal-cells",
                   "Vascular-endothelial-cells", "Lymphoid-cells", "Megakaryocytes",
                   "Squamous-epithelial-cells", "Goblet-cells", "Hepatoblasts")  
par(mar = c(2,2,2,20))
rotate(avg_col_dend, order=rotated_order) %>% 
  set("labels_cex", 1.2) %>%
  plot(horiz=T)
```

