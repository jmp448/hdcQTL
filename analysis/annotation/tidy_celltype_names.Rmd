```{r}
library(tidyverse)
library(SingleCellExperiment)
library(Matrix)
library(Matrix.utils)
library(corrplot)
library(gplots)
library(edgeR)
library(vroom)
```

First, load the FCA cell type profiles
```{r}
fca <- readRDS("/project2/gilad/jpopp/ebQTL/data/fca/counts.subsampled.sce")
```


donor_type <- paste(fca$celltype, fca$Fetus_id, sep="_")
fca_pseudobulk <- aggregate.Matrix(t(counts(fca)), donor_type, fun="sum") 
just_type <- str_extract(rownames(fca_pseudobulk), "[^_]+")

# TMM normalize

fca_medians <- aggregate.Matrix(fca_pseudobulk, just_type, fun="median") %>%
  t %>% as.matrix


Try just taking pseudobulk sum (ignoring fetus ID) 
```{r}
fca_pseudobulk <- aggregate.Matrix(t(counts(fca)), fca$celltype, fun="sum") 

fca_pseudobulk_norm <- DGEList(counts=t(fca_pseudobulk)) %>% 
  calcNormFactors(method="TMMwsp") %>% 
  edgeR::cpm(log=T)

fca_pseudobulk_standardized <- t(apply(fca_pseudobulk_norm, 1, scale))
colnames(fca_pseudobulk_standardized) <- colnames(fca_pseudobulk_norm)
```


Filter to the FCA HVGs and/or cell type signatures
```{r}
hvgs <- read_tsv("data/fca/fca_subsampled_hvg.tsv")
fca_signatures <- readRDS("data/fca/fca_signatures.rds")
```


Next, load EB cell type profiles
Once again going to ignore donor effects
```{r}
eb_pseudobulk_counts <- vroom("data/static_qtl_calling/eb_cellid/pseudobulk_tmm/basic/pseudobulk_all.tsv") %>%
  column_to_rownames("gene") %>% t %>% as("dgCMatrix")

eb_pseudobulk_counts_agg <- aggregate.Matrix(eb_pseudobulk_counts, 
                                             groupings=str_extract(rownames(eb_pseudobulk_counts), "[^_]+$"), 
                                             fun="sum")

eb_pseudobulk_norm <- DGEList(counts=t(eb_pseudobulk_counts_agg)) %>% 
  calcNormFactors(method="TMMwsp") %>% 
  edgeR::cpm(log=T)

eb_pseudobulk_standardized <- t(apply(eb_pseudobulk_norm, 1, scale))
colnames(eb_pseudobulk_standardized) <- colnames(eb_pseudobulk_norm)
```


eb_pseudobulk_sparse <- eb_pseudobulk %>%
  filter(gene %in% fca_pseudobulk$gene) %>%
  column_to_rownames("gene") %>% t %>% as("dgCMatrix")
celltypes <- str_extract(rownames(eb_pseudobulk_sparse), "[^_]+$")

eb_medians <- aggregate.Matrix(eb_pseudobulk_sparse, celltypes, fun="sum") %>%
  t %>% as.matrix()

Look at overlap
```{r, fig.height=10, fig.width=10}
overlap_genes <- intersect(rownames(fca_pseudobulk_norm), rownames(eb_pseudobulk_norm))
hvg_genes <- intersect(overlap_genes, hvgs$gene)

eb_fca_cor <- cor(eb_pseudobulk_norm[overlap_genes,], fca_pseudobulk_norm[overlap_genes,], 
                  method="pearson", use="everything")
     
eb_fca_cor <- cor(eb_pseudobulk_standardized[hvg_genes,], fca_pseudobulk_standardized[hvg_genes,], 
                  method="pearson", use="everything")

heatmap.2(eb_fca_cor, xlab="FCA Cell Type", ylab="EB Cell Type",
          col=bluered, trace="none", cexRow=1.5, cexCol=1.5)
```
eb_fca_cor <- cor(eb_medians[overlap_genes,], fca_pseudobulk[overlap_genes,], 
                  method="pearson", use="everything")


There are some trends that I am really surprised to see, with the fetal cell atlas's metanephric cells looking a lot like *all* EB cell types.

Does this effect persist if we're only looking at a particular cell type's signature genes?
```{r, fig.height=8, fig.width=8}
neuronal_signature_genes <- intersect(overlap_genes, fca_signatures$`CNS neurons`)

neuro_cor <- cor(eb_pseudobulk_norm[neuronal_signature_genes,], 
                 fca_pseudobulk_norm[neuronal_signature_genes,], 
                  method="pearson", use="everything")
                  
heatmap.2(neuro_cor, xlab="FCA Cell Type", ylab="EB Cell Type",
          col=bluered, trace="none", cexRow=1.5, cexCol=1.5, margins=c(15,15))
```

It certainly looks different here. Maybe cell types should be ordered differently, 
according to similarity among their own dataset.
```{r, fig.height=8, fig.width=8}
eb_dend <- as.dendrogram(hclust(dist(t(eb_pseudobulk_norm[neuronal_signature_genes,]))))
fca_dend <- as.dendrogram(hclust(dist(t(fca_pseudobulk_norm[neuronal_signature_genes,]))))

heatmap.2(neuro_cor, xlab="FCA Cell Type", ylab="EB Cell Type",
          Rowv=eb_dend, Colv = fca_dend,
          col=bluered, trace="none", cexRow=1.5, cexCol=1.5, margins=c(15,15))
```

That does seem to work a bit better. What happens if we do something like this, looking across all HVGs?
```{r, fig.height=8, fig.width=8}
eb_dend_hvg <- as.dendrogram(hclust(dist(t(eb_pseudobulk_norm[hvg_genes,])), method="complete"))
fca_dend_hvg <- as.dendrogram(hclust(dist(t(fca_pseudobulk_norm[hvg_genes,])), method="complete"))

hvg_cor <- cor(eb_pseudobulk_norm[hvg_genes,], 
               fca_pseudobulk_norm[hvg_genes,],
               method="pearson", use="everything")
heatmap.2(hvg_cor, xlab="FCA Cell Type", ylab="EB Cell Type",
          Rowv=eb_dend_hvg, Colv = fca_dend_hvg,
          col=bluered, trace="none", cexRow=1.5, cexCol=1.5, margins=c(20,20))
```

Ok, not bad, just for comparison, is looking across all signature genes any different? 
```{r, fig.height=8, fig.width=8}
signature_genes <- as_tibble(fca_signatures) %>%
  pivot_longer(everything(), names_to="type", values_to="gene") %>%
  pull(gene) %>%
  unique() %>%
  intersect(overlap_genes)

eb_dend_sig <- as.dendrogram(hclust(dist(t(eb_pseudobulk_norm[signature_genes,]))))
fca_dend_sig <- as.dendrogram(hclust(dist(t(fca_pseudobulk_norm[signature_genes,]))))

sig_cor <- cor(eb_pseudobulk_norm[signature_genes,], 
               fca_pseudobulk_norm[signature_genes,],
               method="pearson", use="everything")
heatmap.2(sig_cor, xlab="FCA Cell Type", ylab="EB Cell Type",
          Rowv=eb_dend_sig, Colv = fca_dend_sig,
          col=bluered, trace="none", cexRow=1.5, cexCol=1.5, margins=c(20,20))
```

Still though, the comparison to FCA isn't doing much. It's cleaner just to view the auto-correlation
```{r, fig.width=8, fig.height=8}
hvg_cor_eb <- cor(eb_pseudobulk_norm[hvg_genes,],
               method="pearson", use="everything")
heatmap.2(hvg_cor_eb, xlab="FCA Cell Type", ylab="EB Cell Type",
          Rowv=eb_dend_hvg, Colv=eb_dend_hvg,
          col=bluered, trace="none", cexRow=1.5, cexCol=1.5, margins=c(20,20))
```
```{r, fig.width=8, fig.height=8}
hvg_cor_fca <- cor(fca_pseudobulk_norm[hvg_genes,],
               method="pearson", use="everything")
heatmap.2(hvg_cor_fca, xlab="FCA Cell Type", ylab="EB Cell Type",
          Rowv=fca_dend_hvg, Colv=fca_dend_hvg,
          col=bluered, trace="none", cexRow=1.5, cexCol=1.5, margins=c(20,20))
```

Now going to try with standardization
```{r, fig.width=8, fig.height=8}
eb_dend_sig <- as.dendrogram(hclust(dist(t(eb_pseudobulk_standardized[signature_genes,]))))
fca_dend_sig <- as.dendrogram(hclust(dist(t(fca_pseudobulk_standardized[signature_genes,]))))

sig_cor <- cor(eb_pseudobulk_standardized[signature_genes,], 
               fca_pseudobulk_standardized[signature_genes,],
               method="pearson", use="everything")
heatmap.2(sig_cor, xlab="FCA Cell Type", ylab="EB Cell Type",
          col=bluered, trace="none", cexRow=1.5, cexCol=1.5, margins=c(20,20))
heatmap.2(sig_cor, xlab="FCA Cell Type", ylab="EB Cell Type",
          Rowv=eb_dend_sig, Colv = fca_dend_sig,
          col=bluered, trace="none", cexRow=1.5, cexCol=1.5, margins=c(20,20))
```
To determine higher-confidence annotations
```{r}
cors <- as_tibble(sig_cor, rownames="EB_type") %>%
  pivot_longer(!EB_type, names_to="FCA_type", values_to="cor") %>%
  mutate(FCA_type=str_replace_all(FCA_type, pattern=" ", replacement="-")) %>%
  filter(FCA_type %in% EB_type) %>% 
  arrange(EB_type, desc(cor))
```

```{r}
divider <- function(a, b) {
  return(a/b)
}

subtractor <- function(a, b) {
  return(a - b)
}

confidence <- cors %>%
  group_by(EB_type) %>%
  slice_head(n=2) %>%
  mutate(rank=row_number()) %>%
  select(EB_type, cor, rank) %>%
  pivot_wider(id_cols=EB_type, names_from="rank", values_from="cor") %>%
  mutate(factor_diff=map2_dbl(`1`, `2`, divider)) %>%
  mutate(mag_diff=map2_dbl(`1`, `2`, subtractor))
```



```{r, fig.width=8, fig.height=8}
eb_dend_hvg <- as.dendrogram(hclust(dist(t(eb_pseudobulk_standardized[hvg_genes,])), method="average"))
fca_dend_hvg <- as.dendrogram(hclust(dist(t(fca_pseudobulk_standardized[hvg_genes,])), method="average"))

hvg_cor <- cor(eb_pseudobulk_standardized[hvg_genes,], 
               fca_pseudobulk_standardized[hvg_genes,],
               method="pearson", use="everything")
heatmap.2(hvg_cor, xlab="FCA Cell Type", ylab="EB Cell Type",
          col=bluered, trace="none", cexRow=1.5, cexCol=1.5, margins=c(20,20))
heatmap.2(hvg_cor, xlab="FCA Cell Type", ylab="EB Cell Type",
          Rowv=eb_dend_sig, Colv = fca_dend_sig,
          col=bluered, trace="none", cexRow=1.5, cexCol=1.5, margins=c(20,20))
```

```{r, fig.width=8, fig.height=8}
hvg_cor_ebonly <- cor(eb_pseudobulk_standardized[hvg_genes,],
                      method="pearson", use="everything")
heatmap.2(hvg_cor_ebonly, xlab="FCA Cell Type", ylab="EB Cell Type",
          Rowv=eb_dend_sig, Colv = eb_dend_sig,
          col=bluered, trace="none", cexRow=1.5, cexCol=1.5, margins=c(20,20))
```

```{r}
cors_hvg <- as_tibble(hvg_cor, rownames="EB_type") %>%
  pivot_longer(!EB_type, names_to="FCA_type", values_to="cor") %>%
  mutate(FCA_type=str_replace_all(FCA_type, pattern=" ", replacement="-")) %>%
  filter(FCA_type %in% EB_type) %>% 
  arrange(EB_type, desc(cor))

confidence_hvg <- cors_hvg %>%
  group_by(EB_type) %>%
  slice_head(n=2) %>%
  mutate(rank=row_number()) %>%
  select(EB_type, cor, rank) %>%
  pivot_wider(id_cols=EB_type, names_from="rank", values_from="cor") %>%
  mutate(factor_diff=map2_dbl(`1`, `2`, divider)) %>%
  mutate(mag_diff=map2_dbl(`1`, `2`, subtractor))
```


