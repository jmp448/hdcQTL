```{r}
library(tidyverse)
library(patchwork)
```

## Overview of single-cell data
Load the UMAP embedding and cell type assignments
```{r}
umap <- vroom("data/single_cell_objects/eb_pflog1ppfnorm.hvg.umap_embedding.txt", col_names=c("UMAP_1", "UMAP_2"))
celltypes <- vroom("data/fca/eb_cellid_labels.tsv")

sc_annotated <- celltypes %>%
  mutate(umap1=umap$UMAP_1, umap2=umap$UMAP_2)
```

Assign colors to each cell type based on hierarchical clustering
```{r}
type_order <- c("Neuroendocrine-cells", "PNS-neurons", "Skeletal-muscle-cells",                        
                "PNS-glia", "CNS-neurons" , "Retinal-cells", "CNS-glia","Metanephric-cells", 
                "Erythroblasts", "Ciliated-epithelial-cells", "Acinar-cells", "Ductal-cells", 
                "Bronchiolar-and-alveolar-epithelial-cells","Adrenocortical-cells", "Parietal-and-chief-cells", "Ureteric-bud-cells", 
                "Epicardial-fat-cells", "Mesothelial-cells", "Cardiomyocytes", "Mesangial-cells", 
                "Stellate-cells", "Smooth-muscle-cells", "Stromal-cells",
                "Vascular-endothelial-cells", "Lymphoid-cells", "Megakaryocytes",
                "Squamous-epithelial-cells", "Goblet-cells", "Hepatoblasts", 
                "unassigned") 

type_colors <- c("#130063", "#192594", "#004D80", 
                 "#7F7FFF", "#316DFF", "#1B7FFF", "#0097FF", "#7298BB", 
                 "#7F9ACE", "#8CB4D5", "#96C0E5", "#98BEC6", 
                 "#00AB8E", "#3EBFBB", "#55D0B7", "#25C683", 
                 "#860B1E", "#9B1716", "#B51700", "#B13B3E", 
                 "#CC4E4F", "#D32323", "#FF0000",
                 "#965C3D", "#8410D3", "#84108A",  
                 "#FEDE7F", "#FED255", "#FEAE00", 
                 "#D5D5D5") 

color_map <- tibble(type = type_order, color = type_colors) %>%
  mutate(type_spaced = str_replace_all(type, "-", " "))
```

```{r fig.width=8, fig.height=4}
umap_viz <- sc_annotated %>%
  mutate(value = factor(value, levels=color_map$type_spaced)) %>%
  drop_na() # removes a few very rare cell types in the EB data

umap_plot <- ggplot(umap_viz, aes(x=umap1, y=umap2, color=value)) +
  geom_point(size=1e-5) +
  theme_classic(base_size=20) +
  scale_color_manual(values = color_map$color) + 
  guides(color = guide_legend(override.aes = list(size = 10))) +
  xlab("UMAP1") + ylab("UMAP2") + 
  labs(color="Cell Type Assignment")
```

## Overview of Pseudobulk Data
We see that the proportion of cells mapping to each cell type varies widely between donors
```{r, fig.height=8, fig.width=8}
cell_metadata <- vroom("data/single_cell_objects/highpass/eb_metadata.tsv")

donor_celltype <- dplyr::select(cell_metadata, c("cell", "donor_id")) %>%
  inner_join(dplyr::select(sc_annotated, c("cell", "value"))) 
```

Here's what it looks like for different cutoffs on the number of cells req'd for a 
pseudobulk sample
```{r}
thresholds <- seq(10) * 5
all_donors <- unique(donor_celltype$donor_id)

count_celltypes <- function(df, thresh, d) {
  dplyr::count(df, donor_id, value) %>% filter((n>=thresh) & (donor_id==d)) %>% nrow
}

n_types <- expand_grid(thresholds, all_donors) %>%
  mutate(n_types=map2_dbl(thresholds, all_donors, count_celltypes, df=donor_celltype))

ggplot(n_types, aes(x=thresholds, y=n_types, color=all_donors)) +
  geom_line()
```

But most donors to generate most cell types
```{r fig.height=4, fig.width=3}
atleast_5cells <- filter(n_types, thresholds==5)  %>%
  mutate(all_donors = factor(all_donors, levels=pull(arrange(., n_types), all_donors)))
donor_order <- levels(atleast_5cells$all_donors)

types_plot <- ggplot(atleast_5cells, aes(x=all_donors, y=n_types)) +
  geom_segment( aes(x=all_donors, xend=all_donors, y=0, yend=n_types), color="skyblue") +
  geom_point( color="blue", size=5, alpha=0.8) +
  geom_hline(linetype="dashed", color="red", yintercept=median(atleast_5cells$n_types)) +
  coord_flip() +
  theme_classic(base_size=20) +
  xlab("Donor") + ylab("Number of Cell Types")
```

```{r}
proportions_per_celltype <- donor_celltype %>%
  add_count(donor_id, name="donor_n") %>%
  add_count(donor_id, value, name="donor_type_n") %>%
  mutate(proportion=donor_type_n / donor_n) %>%
  dplyr::select(value, donor_id, proportion) %>%
  distinct %>%
  mutate(value = factor(value, levels=color_map$type_spaced)) %>%
  drop_na() %>% # removes rare cell types
  mutate(donor_id=factor(donor_id, levels=donor_order))

props_plot <- ggplot(proportions_per_celltype, aes(x=donor_id, y=proportion, fill=value)) +
  geom_bar(stat="identity", color="black") +
  coord_flip() +
  theme_classic(base_size=20) +
  scale_fill_manual(values=color_map$color) +
  xlab("Donor") + ylab("Cell Type Proportion") + 
  theme(legend.position="none")
props_plot
```

Combine figures
```{r fig.width=14, fig.height=8}
layout <- "
####BBCC
####BBCC
AAAABBCC
AAAABBCC
"
umap_plot + types_plot + props_plot +
  plot_layout(design = layout)
```

# Redo with IPSCs
```{r}
celltypes_ipsc <- vroom("data/fca/eb_cellid_labels.with_ipsc.tsv")

sc_annotated_with_ipsc <- celltypes_ipsc %>%
  mutate(umap1=umap$UMAP_1, umap2=umap$UMAP_2)

type_order_ipsc <- c("Neuroendocrine-cells", "PNS-neurons", "Skeletal-muscle-cells",                        
                "PNS-glia", "CNS-neurons" , "Retinal-cells", "CNS-glia","Metanephric-cells", 
                "Erythroblasts", "Ciliated-epithelial-cells", "Acinar-cells", "Ductal-cells", 
                "Bronchiolar-and-alveolar-epithelial-cells","Adrenocortical-cells", "Parietal-and-chief-cells", "Ureteric-bud-cells", 
                "Epicardial-fat-cells", "Mesothelial-cells", "Cardiomyocytes", "Mesangial-cells", 
                "Stellate-cells", "Smooth-muscle-cells", "Stromal-cells",
                "Vascular-endothelial-cells", "Lymphoid-cells", "Megakaryocytes",
                "Squamous-epithelial-cells", "Goblet-cells", "Hepatoblasts", 
                "IPSC", "unassigned") 

type_colors_ipsc <- c("#130063", "#192594", "#004D80", 
                 "#7F7FFF", "#316DFF", "#1B7FFF", "#0097FF", "#7298BB", 
                 "#7F9ACE", "#8CB4D5", "#96C0E5", "#98BEC6", 
                 "#00AB8E", "#3EBFBB", "#55D0B7", "#25C683", 
                 "#860B1E", "#9B1716", "#B51700", "#B13B3E", 
                 "#CC4E4F", "#D32323", "#FF0000",
                 "#965C3D", "#8410D3", "#84108A",  
                 "#FEDE7F", "#FED255", "#FEAE00", 
                 "#5E5E5E", "#D5D5D5") 

color_map_ipsc <- tibble(type = type_order_ipsc, color = type_colors_ipsc) %>%
  mutate(type_spaced = str_replace_all(type, "-", " "))

```

```{r fig.width=8, fig.height=4}
umap_viz_ipsc <- sc_annotated_with_ipsc %>%
  mutate(value = factor(value, levels=color_map_ipsc$type_spaced)) %>%
  drop_na() # removes a few very rare cell types in the EB data

umap_plot_ipsc <- ggplot(umap_viz_ipsc, aes(x=umap1, y=umap2, color=value)) +
  geom_point(size=1e-5) +
  theme_classic(base_size=20) +
  scale_color_manual(values = color_map_ipsc$color) + 
  guides(color = guide_legend(override.aes = list(size = 10))) +
  xlab("UMAP1") + ylab("UMAP2") + 
  labs(color="Cell Type Assignment")
umap_plot_ipsc
```

### With all 77 cell types
```{r}
celltypes_77 <- vroom("data/fca/eb_cellid_labels.77celltypes.tsv")

sc_annotated_77 <- celltypes_77 %>%
  mutate(umap1=umap$UMAP_1, umap2=umap$UMAP_2)

donor_celltype_77 <- dplyr::select(cell_metadata, c("cell", "donor_id")) %>%
  inner_join(dplyr::select(sc_annotated_77, c("cell", "value"))) %>%
  dplyr::count(donor_id, value)

atleast_5cells_alltypes <- filter(donor_celltype_77, n >= 5)  %>%
  dplyr::count(value)
```

