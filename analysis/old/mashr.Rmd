---
title: "Static and Context-Specific eQTL Calling with mashR"
output: html_notebook
---


```{r}
library(mashr)
library(tidyverse)
```

```{r}
m <- readRDS("../results/mashr/lowpass_annotation_rough/eqtls/mashr.tophits.noendo.rds")
```

```{r}
get_pairwise_sharing(m) %>%
  corrplot(is.corr=F)
```

How many eQTLs do we find?
```{r}
tibble(n_contexts=get_n_significant_conditions(m)) %>%
  filter(n_contexts >= 1) %>%
  count(n_contexts, name="n_eqtl") %>%
  mutate(n_contexts=factor(n_contexts, levels=seq(1, 9))) %>%
  ggplot(aes(x=n_contexts, y=n_eqtl)) +
  geom_bar(stat="identity")
```

Now, of the eQTLs that are specific to one context, which context is it?
```{r}
m$result$lfsr %>%
  as_tibble(rownames="gv") %>%
  pivot_longer(-gv, names_to="type", values_to="lfsr") %>%
  filter(lfsr<=0.05) %>%
  group_by(gv) %>%
  select(-lfsr) %>%
  nest() %>%
  mutate(n_contexts=sapply(data, nrow)) %>%
  filter(n_contexts==1) %>%
  unnest(data) %>%
  group_by(type) %>%
  count() %>%
  ggplot(aes(x=type, y=n, fill=type)) +
  geom_bar(stat="identity") +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

### What are the strongest patterns?
```{r, fig.width=6, fig.height=8}
as_tibble(get_estimated_pi(m), rownames="component") %>%
  mutate(component=factor(component, levels=names(get_estimated_pi(m)))) %>%
  ggplot(aes(x=component, y=value)) +
  geom_bar(stat="identity") +
  scale_x_discrete(limits=rev) +
  xlab("Regulatory Pattern") +
  ylab("Weight") +
  coord_flip() +
  theme_classic(base_size = 20)
  #theme(axis.text.x = element_text(angle = 45, hjust=1))
```

Show boilerplate covariance matrices
```{r fig.width=6, fig.height=3}
type_levels <- c("IPSC", "MESODERM", "ENDODERM", "EPITHELIAL", "EARLYECTO", "NEUR1", "NEUR2", "NEUR3")
type_colors <- c('#F2E4A7', '#C2220D', '#FF9300', '#BE7F00', '#198400', '#00629E', '#6C159A', '#00A1FF')

tibble(type=factor(type_levels, levels=type_levels), value=1) %>%
  ggplot(aes(x=type, y=value, fill=type)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values=type_colors) +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight")

tibble(type=factor(type_levels, levels=type_levels), value=c(0.05, 0.05, 1, 0.05, 0.05, 0.05, 0.05, 0.05)) %>%
  ggplot(aes(x=type, y=value, fill=type)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values=type_colors) +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight")
```


Show more interesting covariance matrices
```{r fig.width=6, fig.height=3}
type_levels <- c("IPSC", "MESODERM", "ENDODERM", "EPITHELIAL", "EARLYECTO", "NEUR1", "NEUR2", "NEUR3")
type_colors <- c('#F2E4A7', '#C2220D', '#FF9300', '#BE7F00', '#198400', '#00629E', '#6C159A', '#00A1FF')

m$fitted_g$Ulist$ED_PCA_1 %>%
  corrplot(is.corr=F)

m$fitted_g$Ulist$ED_PCA_1 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  mutate(type=factor(type, levels=type_levels)) %>%
  ggplot(aes(x=type, y=value, fill=type)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values=type_colors) +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight")

m$fitted_g$Ulist$ED_PCA_4 %>%
  corrplot(is.corr=F)

m$fitted_g$Ulist$ED_PCA_4 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  mutate(type=factor(type, levels=type_levels)) %>%
  ggplot(aes(x=type, y=value, fill=type)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values=type_colors) +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight")
```

Find any significant eQTLs whose effects are best explained by those signals, starting with component 1 (which is highest in IPSC, lower elsewhere)
```{r}
tests <- rownames(get_lfsr(m))
sighits <- get_significant_results(m)
ed1 <- as_tibble(m$posterior_weights) %>%
  rowid_to_column() %>%
  filter(rowid %in% sighits) %>%
  pivot_longer(-rowid, names_to="component", values_to="weight") %>%
  group_by(rowid) %>%
  slice_max(weight) %>%
  filter(component=="ED_PCA_1.17") %>%
  pull(rowid)
mash_plot_meta(m, ed1, colors=meta.colors(box=type_colors))
```

Now looking at component 4
```{r}
ed4 <- as_tibble(m$posterior_weights) %>%
  rowid_to_column() %>%
  filter(rowid %in% sighits) %>%
  pivot_longer(-rowid, names_to="component", values_to="weight") %>%
  group_by(rowid) %>%
  slice_max(weight) %>%
  filter(component=="ED_PCA_4.18") %>%
  pull(rowid)

mash_plot_meta(m, ed4[1])
mash_plot_meta(m, ed4[2], colors=meta.colors(box=type_colors))
```

Now looking at an all-effects component
```{r}
allfx <- as_tibble(m$posterior_weights) %>%
  rowid_to_column() %>%
  filter(rowid %in% sighits) %>%
  pivot_longer(-rowid, names_to="component", values_to="weight") %>%
  group_by(rowid) %>%
  slice_max(weight) %>%
  filter(component=="equal_effects.16") %>%
  pull(rowid)

mash_plot_meta(m, allfx[5], colors=meta.colors(box=type_colors))
```
Now looking at an endoderm component
```{r}
endo <- as_tibble(m$posterior_weights) %>%
  rowid_to_column() %>%
  filter(rowid %in% sighits) %>%
  pivot_longer(-rowid, names_to="component", values_to="weight") %>%
  group_by(rowid) %>%
  slice_max(weight) %>%
  filter(component=="ENDODERM.15") %>%
  pull(rowid)

mash_plot_meta(m, endo[2], colors=meta.colors(box=type_colors))
```

## Including endothelial cells
```{r}
m <- readRDS("../results/mashr/lowpass_annotation_rough/eqtls/mashr.tophits.rds")
```

```{r}
test <- get_pairwise_sharing(m)
corrplot(test, is.corr=F)
```



Now, of the eQTLs that are specific to one context, which context is it?
```{r}
m$result$lfsr %>%
  as_tibble(rownames="gv") %>%
  pivot_longer(-gv, names_to="type", values_to="lfsr") %>%
  filter(lfsr<=0.05) %>%
  group_by(gv) %>%
  select(-lfsr) %>%
  nest() %>%
  mutate(n_contexts=sapply(data, nrow)) %>%
  filter(n_contexts==1) %>%
  unnest(data) %>%
  group_by(type) %>%
  count() %>%
  ggplot(aes(x=type, y=n, fill=type)) +
  geom_bar(stat="identity") +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r}
test <- tibble("type"=c(), "qtls"=c())
for (t in type_levels) {
  test <- bind_rows(test, tibble("type"=t, "qtls"=vroom(paste0("../results/mashr/lowpass_annotation_rough/eqtls/", t, "/eqtls.tophits.tsv")) %>% filter(q<=0.05) %>% nrow(.)))
}
```
```{r}
type_colors <- c('#F2E4A7', '#C2220D', '#FF9300', '#BE7F00', '#198400', '#00629E', '#6C159A', '#00A1FF')

test %>%
  mutate(type=factor(type, levels=type_levels)) %>%
  ggplot(aes(x=type, y=qtls, fill=type)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values=type_colors) +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("# eQTLs")
```


