---
title: "MASH"
output: html_notebook
---
```{r, echo=FALSE, results=FALSE, warning=FALSE}
library(tidyverse)
library(gplots)
library(mashr)
```

## Characterizing mash patterns
```{r}
load("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cellid/pseudobulk_tmm/basic/8pcs/mash_inputs.Rdata")
```

```{r}
ectoderm_types <- c("CNS-neurons", "CNS-glia", "PNS-neurons", "PNS-glia", 
                    "Retinal-cells", "Adrenocortical-cells", "Neuroendocrine-cells"
                    )
epithelial_types <- c("Ciliated-epithelial-cells", "Ductal-cells", "Acinar-cells", 
                      "Metanephric-cells", "Ureteric-bud-cells")
endoderm_types <- c("Goblet-cells", "Hepatoblasts", "Parietal-and-chief-cells", 
                    "Bronchiolar-and-alveolar-epithelial-cells", "Squamous-epithelial-cells")
mesoderm_types <- c("Cardiomyocytes", "Stromal-cells", "Epicardial-fat-cells", 
                    "Mesangial-cells", "Smooth-muscle-cells", "Mesothelial-cells",
                    "Stellate-cells" , "Vascular-endothelial-cells", "Skeletal-muscle-cells")
immune_types <- c("Erythroblasts", "Lymphoid-cells", "Megakaryocytes")

type_levels <- c(ectoderm_types, epithelial_types, mesoderm_types, 
                 endoderm_types, immune_types)
```

Map each germ layer to its own color
```{r}
ecto <- tibble(type=ectoderm_types, layer="ectoderm", color="#0076BA")
epi <- tibble(type=epithelial_types, layer="epithelium", color="#16E7CF")
meso <- tibble(type=mesoderm_types, layer="mesoderm", color="#B51700")
endo <- tibble(type=endoderm_types, layer="endoderm", color="#FEAE00")
immune <- tibble(type=immune_types, layer="immune", color="#970E53")
color_map <- bind_rows(ecto, epi, meso, endo, immune)
```


FLASH factors
```{r}
U.flash$tFLASH_nonneg %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  mutate(type=factor(type, levels=type_levels)) %>%
  ggplot(aes(x=type, y=value, fill=type)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight")
```

Component 1 - dense factor
```{r}
factor_1 <- U.flash$FLASH_nonneg_1 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  left_join(color_map, by="type") %>%
  arrange(type) %>%
  mutate(type=factor(type, levels=color_map$type))
 
factor_1  %>%
  ggplot(aes(x=type, y=value, fill=color)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight") +
  scale_fill_identity() +
  coord_flip() +
  lims(x = rev(levels(factor_1$type)))
```

Component 2 - mesoderm/ endoderm
```{r, fig.height=4, fig.width=4}
factor_2 <- U.flash$FLASH_nonneg_2 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  left_join(color_map, by="type") %>%
  arrange(type) %>%
  mutate(type=factor(type, levels=color_map$type))
 
factor_2  %>%
  ggplot(aes(x=type, y=value, fill=color)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight") +
  scale_fill_identity() +
  coord_flip() +
  lims(x = rev(levels(factor_2$type)))
```

FLASH 3 - Most differentiated cell types
```{r}
factor_3 <- U.flash$FLASH_nonneg_3 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  left_join(color_map, by="type") %>%
  arrange(type) %>%
  mutate(type=factor(type, levels=color_map$type))
 
factor_3  %>%
  ggplot(aes(x=type, y=value, fill=color)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight") +
  scale_fill_identity() +
  coord_flip() +
  lims(x = rev(levels(factor_3$type)))
```

FLASH 4 - Neuroepithelium
```{r, fig.height=4, fig.width=4}
factor_4 <- U.flash$FLASH_nonneg_4 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  left_join(color_map, by="type") %>%
  arrange(type) %>%
  mutate(type=factor(type, levels=color_map$type))
 
factor_4  %>%
  ggplot(aes(x=type, y=value, fill=color)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight") +
  scale_fill_identity() +
  coord_flip() +
  lims(x = rev(levels(factor_4$type)))
```

```{r fig.height=4, fig.width=4}
factor_shared_boilerplate <- factor_1 %>%
  mutate(value=1)

factor_shared_boilerplate  %>%
  ggplot(aes(x=type, y=value, fill=color)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight") +
  scale_fill_identity() +
  coord_flip() +
  lims(x = rev(levels(factor_shared_boilerplate$type)))
```
```{r fig.height=4, fig.width=4}
factor_1_boilerplate <- factor_1 %>%
  mutate(value=c(1, rep(0.01, nrow(.)-1)))

factor_1_boilerplate  %>%
  ggplot(aes(x=type, y=value, fill=color)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight") +
  scale_fill_identity() +
  coord_flip() +
  lims(x = rev(levels(factor_1_boilerplate$type)))
```

Which of these patterns does mash actually rely on the heaviest?
```{r, fig.width=6, fig.height=8}
fitted_m <- readRDS("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cellid/pseudobulk_tmm/basic/8pcs/mash_trained_model.rds")
```

```{r}
as_tibble(get_estimated_pi(fitted_m), rownames="component") %>%
  mutate(component=factor(component, levels=names(get_estimated_pi(fitted_m)))) %>%
  ggplot(aes(x=component, y=value)) +
  geom_bar(stat="identity") +
  scale_x_discrete(limits=rev) +
  xlab("Regulatory Pattern") +
  ylab("Weight") +
  coord_flip() +
  theme_classic(base_size = 10)
```

```{r}
as_tibble(get_estimated_pi(fitted_m, dimension="all"), rownames="component") %>%
  mutate(component=factor(component, levels=names(get_estimated_pi(fitted_m, dimension="all")))) %>%
  filter(value > 0) %>%
  ggplot(aes(x=component, y=value)) +
  geom_bar(stat="identity") +
  scale_x_discrete(limits=rev) +
  xlab("Regulatory Pattern") +
  ylab("Weight") +
  coord_flip() +
  theme_classic(base_size = 10)
```

Let's also compare the numbers of eGenes with and without mash
```{r}
tophits_m <- readRDS("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cellid/pseudobulk_tmm/basic/8pcs/mash_fitted_model.tophits.rds")
tibble(n_contexts=get_n_significant_conditions(tophits_m)) %>%
  filter(n_contexts >= 1) %>%
  dplyr::count(n_contexts, name="n_eqtl") %>%
  mutate(n_contexts=factor(n_contexts, levels=seq(1, 29))) %>%
  ggplot(aes(x=n_contexts, y=n_eqtl)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15)
```

## Power Comparison
```{r}
qtls_by_type <- as_tibble(colSums(get_lfsr(tophits_m) <= 0.05), rownames="type") %>%
  rename(n_eqtl=value)
```


```{r}
permutation_egenes <- read_tsv("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cellid/pseudobulk_tmm/basic/8pcs/signif_variant_gene_pairs.tsv") %>%
  select(celltype, phenotype_id) %>%
  distinct() %>% # one line per egene in a context
  dplyr::count(celltype) %>%
  dplyr::rename(type=celltype, permutations=n)

mash_hits_comparison <- qtls_by_type %>%
  rename(mash=n_eqtl) %>%
  left_join(permutation_egenes, by="type") %>%
  pivot_longer(!type, names_to="method", values_to="n") %>%
  replace_na(list(n=0)) %>%
  mutate(type=factor(type, levels=type_levels))
```
Permutation eGenes
```{r fig.width=3, fig.height=4}
permutation_egenes  %>%
  mutate(type=factor(type, levels=color_map$type)) %>%
  ggplot(aes(x=type, y=permutations)) +
  geom_col(fill="#0076BA") +
  ylab("# Genes with eQTL") + xlab("FCA-Annotated Cell Type") +
  coord_flip() +
  theme_classic(base_size=12) +
  lims(x = rev(levels(factor_3$type)))
```


```{r fig.width=5, fig.height=4}
mash_hits_comparison  %>%
  mutate(type=factor(type, levels=color_map$type)) %>%
  ggplot(aes(x=type, y=n, fill=method)) +
  geom_bar(position="dodge", stat="identity") +
  ylab("# Genes with eQTL") + xlab("FCA-Annotated Cell Type") +
  coord_flip() +
  theme_classic(base_size=12) +
  lims(x = rev(levels(factor_3$type)))
```

See if any of our novel eGenes have interesting patterns
```{r}
sig_contexts <- as_tibble(get_n_significant_conditions(tophits_m), rownames="gv") %>%
  separate(gv, into=c("gene", "variant"), sep="_", remove=F) %>%
  filter(value >= 1)

novel_overlap <- sig_contexts %>%
  filter(gene %in% novel_egenes)
```

To hunt for an interesting example, I'll look at the posterior weights
```{r}
novel_overlap_posteriors <- as_tibble(tophits_m$posterior_weights) %>%
  mutate(gv=rownames(tophits_m$result$lfsr), .before=1) %>%
  separate(gv, into=c("gene", "variant"), sep="_", remove=F) %>%
  right_join(select(novel_overlap, c(gene, value)), by="gene")
```


```{r}
mash_plot_meta(tophits_m, "ADAMTS12_rs7713279", labels=colnames(tophits_m$result$lfsr))
```
