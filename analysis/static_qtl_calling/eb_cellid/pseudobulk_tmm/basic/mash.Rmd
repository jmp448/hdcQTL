---
title: "MASH"
output: html_notebook
---
```{r, echo=FALSE, results=FALSE, warning=FALSE}
library(tidyverse)
library(gplots)
library(mashr)
library(rmeta)
library(vroom)
library(patchwork)
```

## Characterizing mash patterns
```{r}
load("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cellid/pseudobulk_tmm/basic/8pcs/mash_inputs.Rdata")
```

For these visualizations, I'm going to keep the cell type order established
by hierarchical clustering in the `analysis/annotation/tidy_celltype_names.Rmd` notebook
```{r}
type_levels <- c("Neuroendocrine-cells", "PNS-neurons", "Skeletal-muscle-cells",                               
                   "PNS-glia", "CNS-neurons" , "Retinal-cells", "CNS-glia",
                   "Metanephric-cells", "Erythroblasts", "Ciliated-epithelial-cells",
                   "Acinar-cells", "Ductal-cells", "Bronchiolar-and-alveolar-epithelial-cells", "Adrenocortical-cells",
                   "Parietal-and-chief-cells", "Ureteric-bud-cells",
                   "Epicardial-fat-cells", "Mesothelial-cells", "Cardiomyocytes", "Mesangial-cells",
                   "Stellate-cells", "Smooth-muscle-cells", "Stromal-cells",
                   "Vascular-endothelial-cells", "Lymphoid-cells", "Megakaryocytes",
                   "Squamous-epithelial-cells", "Goblet-cells", "Hepatoblasts")  

ectoderm_1 <- tibble(type=c("Neuroendocrine-cells", "PNS-neurons", "Skeletal-muscle-cells"),
                     layer="ecto_1", color="#004D80")
ectoderm_2 <- tibble(type=c("PNS-glia", "CNS-neurons" , "Retinal-cells", "CNS-glia"),
                     layer="ecto_2", color="#0076BA")
neuroepithelium <- tibble(type=c("Metanephric-cells", "Erythroblasts", "Ciliated-epithelial-cells",
                                 "Acinar-cells", "Ductal-cells", "Bronchiolar-and-alveolar-epithelial-cells", "Adrenocortical-cells",
                                 "Parietal-and-chief-cells", "Ureteric-bud-cells"),
                          layer="neuroepithelium", color="#00AB8E")
mesoderm <- tibble(type=c("Epicardial-fat-cells", "Mesothelial-cells", "Cardiomyocytes", "Mesangial-cells",
                          "Stellate-cells", "Smooth-muscle-cells", "Stromal-cells"),
                   layer="mesoderm", color="#B51700")
vasc <- tibble(type=c("Vascular-endothelial-cells"),
               layer="vasc", color="#965C3D")
immune <- tibble(type=c("Lymphoid-cells", "Megakaryocytes"),
                 layer="immune", color="#970E53")
endoderm <- tibble(type=c("Squamous-epithelial-cells", "Goblet-cells", "Hepatoblasts"),
                   layer="endoderm", color="#FEAE00")

color_map <- bind_rows(ectoderm_1, ectoderm_2, neuroepithelium, mesoderm, vasc, immune, endoderm)
```

<!-- Map each germ layer to its own color -->
<!-- ```{r} -->
<!-- ecto <- tibble(type=ectoderm_1, layer="ectoderm", color="#0076BA") -->
<!-- epi <- tibble(type=epithelial_types, layer="epithelium", color="#16E7CF") -->
<!-- meso <- tibble(type=mesoderm_types, layer="mesoderm", color="#B51700") -->
<!-- endo <- tibble(type=endoderm_types, layer="endoderm", color="#FEAE00") -->
<!-- immune <- tibble(type=immune_types, layer="immune", color="#970E53") -->
<!-- color_map <- bind_rows(ecto, epi, meso, endo, immune) -->
<!-- ``` -->

<!-- OR (this is based on the clustering in `annotations/tidy_celltype_names.Rmd`) -->
<!-- ```{r} -->
<!-- type_levels <- c("Vascular-endothelial-cells", "Bronchiolar-and-alveolar-epithelial-cells", "Parietal-and-chief-cells", "Adrenocortical-cells", "Ureteric-bud-cells", "Acinar-cells", "Ductal-cells", "Lymphoid-cells", "Megakaryocytes", "Skeletal-muscle-cells", "Neuroendocrine-cells", "PNS-neurons", "PNS-glia", "Erythroblasts", "Ciliated-epithelial-cells", "CNS-neurons", "Retinal-cells", "CNS-glia", "Metanephric-cells", "Goblet-cells", "Hepatoblasts", "Squamous-epithelial-cells", "Mesangial-cells", "Stellate-cells", "Smooth-muscle-cells", "Stromal-cells", "Cardiomyocytes", "Epicardial-fat-cells", "Mesothelial-cells")  -->

<!-- vasc <- tibble(type="Vascular-endothelial-cells", layer="Vasc_Endo", color="#863108") -->
<!-- epi <- tibble(type=c("Bronchiolar-and-alveolar-epithelial-cells", "Parietal-and-chief-cells", "Adrenocortical-cells", "Ureteric-bud-cells", "Acinar-cells", "Ductal-cells"), layer="epithelium", color="#16E7CF") -->
<!-- immune <- tibble(type=c("Lymphoid-cells", "Megakaryocytes"), layer="immune", color="#970E53") -->
<!-- ecto_1 <- tibble(type=c("Skeletal-muscle-cells", "Neuroendocrine-cells", "PNS-neurons"), layer="ecto_1", color="#004D80") -->
<!-- ecto_2 <- tibble(type=c("PNS-glia", "Erythroblasts", "Ciliated-epithelial-cells", "CNS-neurons", "Retinal-cells", "CNS-glia", "Metanephric-cells"), layer="ecto_2", color="#0076BA") -->
<!-- endo <- tibble(type=c("Goblet-cells", "Hepatoblasts"), layer="endoderm", color="#FEAE00") -->
<!-- squa <- tibble(type="Squamous-epithelial-cells", layer="Squa_Epi", color="#FE7000") -->
<!-- meso <- tibble(type=c("Mesangial-cells", "Stellate-cells", "Smooth-muscle-cells", "Stromal-cells", "Cardiomyocytes", "Epicardial-fat-cells", "Mesothelial-cells"), layer="mesoderm", color="#B51700") -->
<!-- color_map <- bind_rows(vasc, epi, immune, ecto_1, ecto_2, endo, squa, meso) -->
<!-- ``` -->





FLASH factors
```{r}
U.flash$tFLASH_nonneg %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  mutate(type=factor(type, levels=type_levels)) %>%
  ggplot(aes(x=type, y=value, fill=type)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight")
```

Component 1 - dense factor
```{r}
factor_1 <- U.flash$FLASH_nonneg_1 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  left_join(color_map, by="type") %>%
  arrange(type) %>%
  mutate(type=factor(type, levels=color_map$type))
 
mash_factor_1 <- ggplot(factor_1, aes(x=type, y=value, fill=color)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight") +
  scale_fill_identity() +
  coord_flip() +
  lims(x = rev(levels(factor_1$type)))
mash_factor_1
```

Component 2 - mesoderm/ endoderm
```{r}
factor_2 <- U.flash$FLASH_nonneg_2 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  left_join(color_map, by="type") %>%
  arrange(type) %>%
  mutate(type=factor(type, levels=color_map$type))
 
mash_factor_2 <- ggplot(factor_2, aes(x=type, y=value, fill=color)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight") +
  scale_fill_identity() +
  coord_flip() +
  lims(x = rev(levels(factor_2$type)))
mash_factor_2
```

FLASH 3 - Most differentiated cell types
```{r}
factor_3 <- U.flash$FLASH_nonneg_3 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  left_join(color_map, by="type") %>%
  arrange(type) %>%
  mutate(type=factor(type, levels=color_map$type))
 
mash_factor_3 <- ggplot(factor_3, aes(x=type, y=value, fill=color)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight") +
  scale_fill_identity() +
  coord_flip() +
  lims(x = rev(levels(factor_3$type)))
mash_factor_3
```

FLASH 4 - Neuroepithelium
```{r}
factor_4 <- U.flash$FLASH_nonneg_4 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  left_join(color_map, by="type") %>%
  arrange(type) %>%
  mutate(type=factor(type, levels=color_map$type))
 
mash_factor_4 <- ggplot(factor_4, aes(x=type, y=value, fill=color)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight") +
  scale_fill_identity() +
  coord_flip() +
  lims(x = rev(levels(factor_4$type)))
mash_factor_4
```

```{r}
factor_shared_boilerplate <- factor_1 %>%
  mutate(value=1)

factor_shared_boilerplate  %>%
  ggplot(aes(x=type, y=value, fill=color)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight") +
  scale_fill_identity() +
  coord_flip() +
  lims(x = rev(levels(factor_shared_boilerplate$type)))
```
```{r}
factor_1_boilerplate <- factor_1 %>%
  mutate(value=c(1, rep(0.01, nrow(.)-1)))

factor_1_boilerplate  %>%
  ggplot(aes(x=type, y=value, fill=color)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight") +
  scale_fill_identity() +
  coord_flip() +
  lims(x = rev(levels(factor_1_boilerplate$type)))
```

Which of these patterns does mash actually rely on the heaviest?
```{r, fig.width=6, fig.height=8}
fitted_m <- readRDS("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cellid/pseudobulk_tmm/basic/8pcs/mash_trained_model.rds")
```

```{r}
as_tibble(get_estimated_pi(fitted_m), rownames="component") %>%
  mutate(component=factor(component, levels=names(get_estimated_pi(fitted_m)))) %>%
  ggplot(aes(x=component, y=value)) +
  geom_bar(stat="identity") +
  scale_x_discrete(limits=rev) +
  xlab("Regulatory Pattern") +
  ylab("Weight") +
  coord_flip() +
  theme_classic(base_size = 10)
```

```{r}
as_tibble(get_estimated_pi(fitted_m, dimension="all"), rownames="component") %>%
  mutate(component=factor(component, levels=names(get_estimated_pi(fitted_m, dimension="all")))) %>%
  filter(value > 0) %>%
  ggplot(aes(x=component, y=value)) +
  geom_bar(stat="identity") +
  scale_x_discrete(limits=rev) +
  xlab("Regulatory Pattern") +
  ylab("Weight") +
  coord_flip() +
  theme_classic(base_size = 10)
```

Let's also compare the numbers of eGenes with and without mash
```{r}
tophits_m <- readRDS("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cellid/pseudobulk_tmm/basic/8pcs/mash_fitted_model.tophits.rds")
tibble(n_contexts=get_n_significant_conditions(tophits_m)) %>%
  filter(n_contexts >= 1) %>%
  dplyr::count(n_contexts, name="n_eqtl") %>%
  mutate(n_contexts=factor(n_contexts, levels=seq(1, 29))) %>%
  ggplot(aes(x=n_contexts, y=n_eqtl)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15)
```

<!-- ## Power Comparison -->
<!-- First, how many eGenes does mash detect when only testing the top hits per gene? -->
<!-- ```{r} -->
<!-- sum(get_n_significant_conditions(tophits_m) >= 1) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- qtls_by_type <- as_tibble(colSums(get_lfsr(tophits_m) <= 0.05), rownames="type") %>% -->
<!--   rename(n_eqtl=value) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- permutation_egenes <- read_tsv("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cellid/pseudobulk_tmm/basic/8pcs/signif_variant_gene_pairs.tsv") %>% -->
<!--   dplyr::select(celltype, phenotype_id) %>% -->
<!--   distinct() %>% # one line per egene in a context -->
<!--   dplyr::count(celltype) %>% -->
<!--   dplyr::rename(type=celltype, permutations=n) -->

<!-- mash_hits_comparison <- qtls_by_type %>% -->
<!--   rename(mash=n_eqtl) %>% -->
<!--   left_join(permutation_egenes, by="type") %>% -->
<!--   pivot_longer(!type, names_to="method", values_to="n") %>% -->
<!--   replace_na(list(n=0)) %>% -->
<!--   mutate(type=factor(type, levels=type_levels)) -->
<!-- ``` -->

<!-- Permutation eGenes -->
<!-- ```{r fig.width=3, fig.height=4} -->
<!-- permutation_egenes  %>% -->
<!--   mutate(type=factor(type, levels=type_levels)) %>% -->
<!--   ggplot(aes(x=type, y=permutations)) + -->
<!--   geom_col(fill="#0076BA") + -->
<!--   ylab("# Genes with eQTL") + xlab("FCA-Annotated Cell Type") + -->
<!--   coord_flip() + -->
<!--   theme_classic(base_size=12) + -->
<!--   lims(x = rev(levels(type_levels))) -->
<!-- ``` -->


<!-- ```{r fig.width=5, fig.height=4} -->
<!-- mash_hits_comparison  %>% -->
<!--   mutate(type=factor(type, levels=type_levels)) %>% -->
<!--   ggplot(aes(x=type, y=n, fill=method)) + -->
<!--   geom_bar(position="dodge", stat="identity") + -->
<!--   ylab("# Genes with eQTL") + xlab("FCA-Annotated Cell Type") + -->
<!--   coord_flip() + -->
<!--   theme_classic(base_size=12)  -->
<!-- #+ -->
<!-- #  lims(x = rev(levels(type_levels))) -->
<!-- ``` -->

## Exploring Specific Examples
```{r}
mash_sighits_bed_loc <- "/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/qtl_sets/mash/original/mash-signif_variant_gene_pairs.bed"
mash_sighits_overlap_loc <- "/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/qtl_sets/mash/original/mash-signif_variant_gene_pairs.all_tissue_overlap.bed"

gtex_overlap <- vroom(mash_sighits_overlap_loc, col_names=c("CHR", "START", "STOP", "EB_ENSG", "EB_HGNC", 
                                                          "RSID", "CELLTYPE", "CHR1", "START1", 
                                                          "STOP1", "GTEX_ENSG", "GTEX_REF", "GTEX_ALT"))
eb_all <- vroom(mash_sighits_bed_loc)

overlap_egenes <- unique(gtex_overlap$EB_HGNC)
all_egenes <- unique(eb_all$EB_HGNC)
novel_egenes <- setdiff(all_egenes, overlap_egenes)
```

See if any of our novel eQTLs have interesting patterns
```{r}
full_m <- readRDS("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cellid/pseudobulk_tmm/basic/8pcs/mash_fitted_model.full.rds")

n_contexts <- as_tibble(mashr::get_n_significant_conditions(full_m), rownames="gv")

novel_overlap_posteriors <- as_tibble(full_m$posterior_weights) %>%
  mutate(gv=rownames(full_m$result$lfsr), .before=1) %>%
  left_join(n_contexts, by="gv") %>%
  filter(value >= 1) %>%
  separate(gv, into=c("gene", "variant"), sep="_", remove=F) %>%
  filter(gene %in% novel_egenes)
```

Ideally, an example will not only not be found in GTEx, but it will have been missed by our previous analysis
```{r}
permutation_ehits <- read_tsv("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/qtl_sets/tensorqtl/original/signif_variant_gene_pairs.bed")

doubly_novel_overlap_posteriors <- filter(novel_overlap_posteriors, !gene %in% permutation_ehits$EB_HGNC)
```

Are any of these effects significant in some-but-not-all contexts?
```{r}
highly_variable_effects <- filter(doubly_novel_overlap_posteriors,(value >= 3) & (value <= 15))
```

Now for the sake of visualization, winnow those down to the ones that were tested in most EB contexts 
in the celltype-by-celltype analysis
```{r}
nonmash_effects <- vroom("results/static_qtl_calling/eb_cellid/pseudobulk_tmm/basic/8pcs/tensorqtl_nominal.all.tsv")

measured_contexts <- unite(nonmash_effects, col="gv", phenotype_id, variant_id, sep="_", remove=F) %>%
  dplyr::count(gv) %>%
  filter(n >= 20)

highly_variable_effects_measured <- inner_join(highly_variable_effects, measured_contexts, by="gv")
```

```{r}
mash_colors <- color_map %>%
  arrange(type) %>%
  pull(color)
```

```{r}
mash_plot_meta(full_m, "SH3PXD2B_rs10042482", labels=colnames(full_m$result$lfsr),
               colors=meta.colors(box=mash_colors))
```

How does this compare to the effects we learned in the celltype-by-celltype analysis?
```{r fig.width=4, fig.height=5}
nonmash_viz <- filter(nonmash_effects, (variant_id=="rs10042482") & (phenotype_id=="SH3PXD2B"))

nonmash_colors <- color_map %>%
  right_join(nonmash_viz, by=c("type"="celltype")) %>%
  arrange(type) %>%
  pull(color)

metaplot(nonmash_viz$slope, nonmash_viz$slope_se, labels=nonmash_viz$celltype,
         colors=meta.colors(box=nonmash_colors), xlab="Effect Size",
         ylab="Celltype")
```

Redo mash plot with expanded x limits
```{r fig.width=4, fig.height=5}
mash_plot_meta(full_m, "SH3PXD2B_rs10042482", labels=colnames(full_m$result$lfsr),
               xlim=c(-0.8, 0.6),
               colors=meta.colors(box=mash_colors))
```
Plot these on same axis. First, get the color scheme sorted
```{r}
color_map_mash_fig <- color_map %>%
  mutate(layer=factor(layer, levels=c("epithelium", "immune", "ecto_1", "ecto_2", "endoderm", "Squa_Epi", "mesoderm", "Vasc_Endo"))) %>%
  arrange(layer)

type_order <- color_map_mash_fig$type
color_order <- color_map_mash_fig$color
```


```{r}
mash_posterior_betas <- get_pm(full_m)["SH3PXD2B_rs10042482",]
mash_posterior_sds <- get_psd(full_m)["SH3PXD2B_rs10042482",]
mash_precision <- 1 / mash_posterior_sds ** 2
mash_celltypes <- colnames(get_pm(full_m))
mash_ests <- tibble(celltype=mash_celltypes,
                    beta=mash_posterior_betas,
                    sd=mash_posterior_sds,
                    precision=mash_precision,
                    approach=rep("mash", length(mash_celltypes)))

nonmash_betas <- nonmash_viz$slope
nonmash_sds <- nonmash_viz$slope_se
nonmash_precision <- 1 / nonmash_sds ** 2
nonmash_celltypes <- nonmash_viz$celltype
nonmash_ests <- tibble(celltype=nonmash_celltypes,
                    beta=nonmash_betas,
                    sd=nonmash_sds,
                    precision=nonmash_precision,
                    approach=rep("non-mash", length(nonmash_celltypes)))

mash_comp_viz <- bind_rows(mash_ests, nonmash_ests) %>%
  mutate(approach=case_match(factor(approach, levels=c("non-mash", "mash")), "non-mash" ~ "Univariate Analysis", "mash" ~ "Multivariate Analysis")) %>%
  mutate(approach=factor(approach, levels=c("Univariate Analysis", "Multivariate Analysis"))) %>%
  mutate(celltype=factor(celltype, levels=rev(type_order)))

mash_example_plot <- ggplot(mash_comp_viz, aes(x=celltype, y=beta, color=celltype)) +
  geom_hline(aes(yintercept=0), linetype="dashed", color="red") +
  geom_errorbar(aes(ymin=beta - sd, ymax=beta + sd), color="#D5D5D5", width=0.5) +
  geom_point(aes(size=precision), shape=15) +
  theme_classic(base_size=20) +
  theme(legend.position = "none", axis.text.x = element_text(angle=45, hjust=1)) +
  scale_color_manual(values=rev(color_order)) +
  coord_flip() +
  facet_grid(cols=vars(approach)) +
  xlab("Cell Type") +
  ylab("Estimated Effect Size") 
```

```{r fig.height=4, fig.width=12}
layout <- "
  ABEEEE
  CDEEEE
"
mash_factor_1 + mash_factor_2 + mash_factor_3 + mash_factor_4 + mash_example_plot + 
  plot_layout(design = layout)
```

Rework the mash factors plot to have a shared y-axis 
```{r}
mash_factor_1 <- ggplot(factor_1, aes(x=type, y=value, fill=color)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=20) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight") +
  scale_fill_identity() +
  coord_flip() +
  lims(x = rev(levels(factor_1$type)))

mash_factor_2 <- ggplot(factor_2, aes(x=type, y=value, fill=color)) +
    geom_bar(stat="identity") +
    theme_classic(base_size=20) +
    theme(axis.text.x = element_text(angle=30, hjust=1), 
          axis.text.y = element_blank(),
          legend.position="none") +
    xlab("") + ylab("Weight") +
    scale_fill_identity() +
    coord_flip() +
    lims(x = rev(levels(factor_2$type)))

mash_factor_3 <- ggplot(factor_3, aes(x=type, y=value, fill=color)) +
    geom_bar(stat="identity") +
    theme_classic(base_size=20) +
    theme(axis.text.x = element_text(angle=30, hjust=1), 
          axis.text.y = element_blank(),
          legend.position="none") +
    xlab("") + ylab("Weight") +
    scale_fill_identity() +
    coord_flip() +
    lims(x = rev(levels(factor_3$type)))

mash_factor_4 <- ggplot(factor_4, aes(x=type, y=value, fill=color)) +
    geom_bar(stat="identity") +
    theme_classic(base_size=20) +
    theme(axis.text.x = element_text(angle=30, hjust=1), 
          axis.text.y = element_blank(),
          legend.position="none") +
    xlab("") + ylab("Weight") +
    scale_fill_identity() +
    coord_flip() +
    lims(x = rev(levels(factor_4$type)))
```


```{r fig.height=8, fig.width=20}
factors_all <- bind_rows(factor_1, factor_2, factor_3, factor_4) %>%
  mutate(factor_name=rep(c("Factor 1", "Factor 2", "Factor 3", "Factor 4"), each=29)) 

mash_factors_all <- ggplot(factors_all, aes(x=type, y=value, fill=color)) +
    geom_bar(stat="identity") +
    theme_classic(base_size=20) +
    theme(axis.text.x = element_text(angle=30, hjust=1), 
          legend.position="none") +
    xlab("Cell Type") + ylab("Weight") +
    scale_fill_identity() +
    coord_flip() +
    lims(x = rev(type_order)) +
  facet_grid(cols=vars(factor_name))
layout <- "
  AAAABBB
  AAAABBB
"
mash_factors_all + mash_example_plot +
  plot_layout(design=layout)
```

