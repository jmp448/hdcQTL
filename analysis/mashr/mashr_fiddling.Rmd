---
title: "mashR Alternatives"
output: html_notebook
---

Goal: get more interesting patterns from mashR

```{r}
library(tidyverse)
library(mashr)
library(vroom)
library(flashr)
```

Get QTL info
```{r}
load_qtls <- function(s) {
  t <- str_split(s, "/")[[1]][12]
  qtls <- vroom(s) %>%
    add_column(type=t)
  qtls
}

# compute standard errors, omitting tests where we can't obtain reasonable estimates
celltypes <- c('Astrocytes', 'Visceral-neurons', 'Amacrine-cells',
'Oligodendrocytes', 'Ganglion-cells', 'Smooth-muscle-cells', 
'Limbic-system-neurons', 'Vascular-endothelial-cells', 
'Photoreceptor-cells', 'CCL19-CCL21-positive-cells', 
'CLC-IL5RA-positive-cells', 'Mesangial-cells', 'AFP-ALB-positive-cells', 
'Bipolar-cells', 'Satellite-cells', 'ENS-neurons', 'ENS-glia', 
'Granule-neurons', 'Hepatoblasts', 'Microglia', 'IGFBP1-DKK1-positive-cells', 
'Purkinje-neurons', 'Epicardial-fat-cells', 'Cardiomyocytes')

qtl_files <- paste0("/project2/gilad/jpopp/ebQTL/results/mashr/aggregation/type/highpass_cellid_confident/eqtls/", 
                    celltypes, "/eqtls.mtc.tsv")

qtls <- map_dfr(qtl_files, load_qtls)

# subset to snps that were kept for all analyses
qtls <- qtls %>%
  mutate(se=if_else(`t-stat`==0, as.double(NA), beta/`t-stat`), .after='beta') %>%
  mutate(se=if_else(se==0, as.double(NA), se)) %>%
  drop_na() %>%
  unite(gv, c(gene, SNP), sep="--", remove=FALSE)

keepers <- qtls %>%
  dplyr::count(gv) %>% 
  filter(n==length(qtl_files)) %>%
  pull(gv)

qtls <- qtls %>%
  filter(gv %in% keepers)
saveRDS(qtls, "/project2/gilad/jpopp/ebQTL/temp/qtls_combined.rds")

beta.hat <- qtls %>%
  select(gv, beta, type) %>%
  pivot_wider(names_from=type, values_from=beta, values_fill=NA) %>%
  column_to_rownames("gv") %>% as.matrix

se.hat <- qtls %>%
  select(gv, se, type) %>%
  pivot_wider(names_from=type, values_from=se, values_fill=NA) %>%
  column_to_rownames("gv") %>% as.matrix

df.hat <- qtls %>%
  select(gv, df, type) %>%
  pivot_wider(names_from=type, values_from=df, values_fill=NA) %>%
  column_to_rownames("gv") %>% as.matrix

top.hits <- qtls %>%
  select(gv, gene, `t-stat`, type) %>%
  mutate(`t-stat`=abs(`t-stat`)) %>%
  group_by(gene) %>%
  slice_max(`t-stat`, n=1, with_ties=FALSE) %>%
  pull(gv)
random.hits = sample(qtls$gv, min(250000, length(unique(qtls$gv))))

# estimate null correlation
data.temp = mash_set_data(beta.hat[random.hits,],se.hat[random.hits,])
Vhat = estimate_null_correlation_simple(data.temp)

data.random = mash_set_data(beta.hat[random.hits,], se.hat[random.hits,], V=Vhat, df=df.hat[random.hits,])
data.strong = mash_set_data(beta.hat[top.hits,], se.hat[top.hits,], V=Vhat, df=df.hat[top.hits,])
```

What do the existing mashR matrices look like? 
```{r}
m <- readRDS("results/mashr/pseudobulk/type/highpass_cellid_confident/eqtls/mashr.tophits.rds")
names(m$fitted_g$Ulist)
```

Here we've got 5 "ED PCA" matrices, one "ED tPCA" matrix, the identity matrix, specific effects for each context, equal effects, and simple het effects. What do the ED PC matrices look like?
```{r}
corrplot(m$fitted_g$Ulist$ED_PCA_1)
corrplot(m$fitted_g$Ulist$ED_PCA_2)
corrplot(m$fitted_g$Ulist$ED_PCA_3)
corrplot(m$fitted_g$Ulist$ED_PCA_4)
corrplot(m$fitted_g$Ulist$ED_PCA_5)
corrplot(m$fitted_g$Ulist$ED_tPCA)
```

Sooo that's a problem! How about those het ones?
```{r}
corrplot(m$fitted_g$Ulist$simple_het_1)
corrplot(m$fitted_g$Ulist$simple_het_2)
corrplot(m$fitted_g$Ulist$simple_het_3)
```

So these... all suck, no wonder we are not seeing interesting patterns. Looking under the hood, lets see if maybe we're running into some issues just from PCA
```{r}
U.pca = cov_pca(data.strong, 5)

corrplot(U.pca$PCA_1, is.corr=F)
corrplot(U.pca$PCA_2, is.corr=F)
corrplot(U.pca$PCA_3, is.corr=F)
corrplot(U.pca$PCA_4, is.corr=F)
corrplot(U.pca$PCA_5, is.corr=F)
corrplot(U.pca$tPCA, is.corr=F)
```

If we want to see the patterns coming out, we obviously need to have some patterns going in, and right now, we do not. 
```{r}
all_tophits <- qtls %>%
  select(gv, gene, `bonf.p`, type) %>%
  group_by(gene) %>%
  slice_min(`bonf.p`, n=1, with_ties=FALSE)
all_tophits$q <- qvalue(sighits$bonf.p)$qvalues

sighits <- all_tophits %>%
  filter(q<=0.05)

sig.hits <- pull(sighits, gv)
```

```{r}
data.stronger = mash_set_data(beta.hat[sig.hits,], se.hat[sig.hits,], V=Vhat, df=df.hat[sig.hits,])

U.pca.stronger = cov_pca(data.stronger, 5)

corrplot(U.pca.stronger$PCA_1, is.corr=F)
corrplot(U.pca.stronger$PCA_2, is.corr=F)
corrplot(U.pca.stronger$PCA_3, is.corr=F)
corrplot(U.pca.stronger$PCA_4, is.corr=F)
corrplot(U.pca.stronger$PCA_5, is.corr=F)
corrplot(U.pca.stronger$tPCA, is.corr=F)
```

Feed this into the ED algorithm
```{r}
U.ed.stronger = cov_ed(data.stronger, U.pca.stronger)

corrplot(U.pca.stronger$ED_PCA_1, is.corr=F)
corrplot(U.pca.stronger$ED_PCA_2, is.corr=F)
corrplot(U.pca.stronger$ED_PCA_3, is.corr=F)
corrplot(U.pca.stronger$ED_PCA_4, is.corr=F)
corrplot(U.pca.stronger$ED_PCA_5, is.corr=F)
corrplot(U.pca.stronger$ED_tPCA, is.corr=F)
```

We are maybe starting to get somewhere, but it's still not quite where we'd like it to be. Also worth noting that this is pretty similar to the original one.
```{r}
U.flash = cov_flash(data.stronger, remove_singleton=T)

corrplot(U.flash$tFLASH_default, is.corr=F)
corrplot(U.flash$FLASH_default_1, is.corr=F)
corrplot(U.flash$FLASH_default_2, is.corr=F)
corrplot(U.flash$FLASH_default_3, is.corr=F)
corrplot(U.flash$FLASH_default_4, is.corr=F)
corrplot(U.flash$FLASH_default_5, is.corr=F)
corrplot(U.flash$FLASH_default_6, is.corr=F)
corrplot(U.flash$FLASH_default_7, is.corr=F)
corrplot(U.flash$FLASH_default_8, is.corr=F)
corrplot(U.flash$FLASH_default_9, is.corr=F)
corrplot(U.flash$FLASH_default_10, is.corr=F)
```


