---
title: "Pseudobulk QC"
output: html_notebook
---

```{r}
celltypes_loc <- "/project2/gilad/jpopp/ebQTL/data/single_cell_objects/highpass_cellid_confident.pseudobulk-scran.tsv"

cell.types <- read_tsv(celltypes_loc, n_max=0, col_select=-c(1)) %>%
  colnames() %>%
  sapply(function(s){str_split(s, "_")[[1]][2]}) %>% 
  unique()
```

```{r}
qc_figs <- paste0("/project2/gilad/jpopp/ebQTL/figs/static/highpass_cellid_confident/pseudobulk-scran/", cell.types, "/qc.png")
knitr::include_graphics(qc_figs)
```

There are a few of these that are worth following up on.
```{r}
pcs_prefix <- "/project2/gilad/jpopp/ebQTL/data/static/highpass_cellid_confident/pseudobulk-scran/"
```


#### Astrocytes
It looks like there's a bit of an outlier with a much lower PC2 value, is that due to number of cells (19101)?
```{r}
read_tsv(paste0(pcs_prefix, "Astrocytes/all_pcs.tsv")) %>%
  column_to_rownames("covariate") %>% as.data.frame() %>% t() %>%
  as_tibble(rownames="individual") %>% arrange(PC2)
```
No, I'll leave it as is

#### CCL19-CCL21 Positive Cells
Same as before, who's the outlier at PC2?
```{r}
read_tsv(paste0(pcs_prefix, "CCL19-CCL21-positive-cells/all_pcs.tsv")) %>%
  column_to_rownames("covariate") %>% as.data.frame() %>% t() %>%
  as_tibble(rownames="individual") %>% arrange(PC2)
```

#### Photoreceptor Cells
Same as before, who's the outlier at PC2?
```{r}
read_tsv(paste0(pcs_prefix, "Photoreceptor-cells/all_pcs.tsv")) %>%
  column_to_rownames("covariate") %>% as.data.frame() %>% t() %>%
  as_tibble(rownames="individual") %>% arrange(PC2)
```

#### Purkinje Neurons
Purkinje neurons just look a little off all around
```{r}
read_tsv(paste0(pcs_prefix, "Purkinje-neurons/all_pcs.tsv")) %>%
  column_to_rownames("covariate") %>% as.data.frame() %>% t() %>%
  as_tibble(rownames="individual") %>% arrange(PC1)

read_tsv(paste0(pcs_prefix, "Purkinje-neurons/all_pcs.tsv")) %>%
  column_to_rownames("covariate") %>% as.data.frame() %>% t() %>%
  as_tibble(rownames="individual") %>% arrange(PC2)
```

#### Satellite cells
```{r}
read_tsv(paste0(pcs_prefix, "Satellite-cells/all_pcs.tsv")) %>%
  column_to_rownames("covariate") %>% as.data.frame() %>% t() %>%
  as_tibble(rownames="individual") %>% arrange(desc(PC1))

read_tsv(paste0(pcs_prefix, "Satellite-cells/all_pcs.tsv")) %>%
  column_to_rownames("covariate") %>% as.data.frame() %>% t() %>%
  as_tibble(rownames="individual") %>% arrange(PC2)
```
Ok here we may have a bit of an issue with 19116, it's way more cells than the others, and is *kind of* an outlier for PC2? It's not crazy though, should be manageable just by regressing out PCs? I'm not going to remove it for now

#### Vascular endothelial cells
Maybe some with an outlier PC2, but not by cell num
```{r}
read_tsv(paste0(pcs_prefix, "Vascular-endothelial-cells/all_pcs.tsv")) %>%
  column_to_rownames("covariate") %>% as.data.frame() %>% t() %>%
  as_tibble(rownames="individual") %>% arrange(desc(PC2))
```

So, for now, not planning to make any changes I think this all really looks ok! Will loop back to a more thorough analysis of each PC though
