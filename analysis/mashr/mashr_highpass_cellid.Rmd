---
title: "Static and Context-Specific eQTL Calling with mashR"
output: html_notebook
---


```{r}
library(mashr)
library(corrplot)
library(tidyverse)
library(qvalue)
```

```{r}
type_levels <- c('Astrocytes', 'Visceral-neurons', 'Amacrine-cells',
'Oligodendrocytes', 'Ganglion-cells', 'Smooth-muscle-cells', 
'Limbic-system-neurons', 'Vascular-endothelial-cells', 
'Photoreceptor-cells', 'CCL19-CCL21-positive-cells', 
'CLC-IL5RA-positive-cells', 'Mesangial-cells', 'AFP-ALB-positive-cells', 
'Bipolar-cells', 'Satellite-cells', 'ENS-neurons', 'ENS-glia', 
'Granule-neurons', 'Hepatoblasts', 'Microglia', 'IGFBP1-DKK1-positive-cells', 
'Purkinje-neurons', 'Epicardial-fat-cells', 'Cardiomyocytes')

```

## Quick View
How many cells do we have per cell type and per individual?
```{r, fig.width=6.5, fig.height=10}
sample_summary <- read_tsv("/project2/gilad/jpopp/ebQTL/data/static/pseudobulk/type/highpass_030222_lowres/sample_summary.tsv") %>%
  mutate(individual=factor(individual), type=factor(type, levels=type_levels))

sample_summary %>%
  arrange(n_cells) %>%
  ggplot(aes(x=individual, y=n_cells)) +
  geom_bar(stat="identity") +
  facet_grid(rows=vars(type), scales="free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

How many UMIs? (This tells the same story, nUMI and nCells very highly correlated)
```{r, fig.width=6.5, fig.height=10}
sample_summary %>%
  arrange(n_umi) %>%
  ggplot(aes(x=individual, y=n_umi)) +
  geom_bar(stat="identity") +
  facet_grid(rows=vars(type), scales="free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

For each cell type, how many individuals have at least 5 cells? (This is the cutoff for having a pseudobulk sample)
```{r, fig.width=12, fig.height=6}
ct_summary <- read_tsv("/project2/gilad/jpopp/ebQTL/data/static/pseudobulk/type/highpass_030222_lowres/samples_per_celltype.tsv") %>%
  mutate(type=factor(type, levels=type_levels))

ct_summary  %>%
  ggplot(aes(x=type, y=n, fill=type)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values=type_colors) +
  ylab("n samples") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

## MashR Results
```{r}
m <- readRDS("results/mashr/aggregation/type/highpass_cellid_confident/eqtls/mashr.tophits.rds")
```

```{r}
get_pairwise_sharing(m) %>%
  corrplot(is.corr=F, order='hclust', tl.pos='lt')
```
Get the first PC of the covariance matrix
```{r}
decomp <- get_pairwise_sharing(m) %>%
  princomp
```

```{r}
plot(decomp$sdev)
```



How many eQTLs do we find?
```{r}
tibble(n_contexts=get_n_significant_conditions(m)) %>%
  filter(n_contexts >= 1) %>%
  dplyr::count(n_contexts, name="n_eqtl") %>%
  mutate(n_contexts=factor(n_contexts, levels=seq(1, 24))) %>%
  ggplot(aes(x=n_contexts, y=n_eqtl)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15)
```
```{r}
n_qtl <- colSums(m$result$lfsr <= 0.05)

qtl_by_type <- tibble(type=names(n_qtl), n_eqtl=n_qtl)  %>% 
  arrange(n_qtl)

ggplot(qtl_by_type, aes(x=type, y=n_eqtl, fill=type)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=45, hjust=1), legend.position="none")

ggplot(qtl_by_type, aes(x=type, y=n_eqtl)) +
  geom_segment( aes(x=type, xend=type, y=0, yend=n_eqtl), color="skyblue") +
  geom_point( color="blue", size=8, alpha=0.6) +
  theme_light(base_size=25) +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  ) +
  ylab("# Genes with eQTL") + xlab("FCA-Annotated Cell Type")
```


```{r}
tibble(n_contexts=get_n_significant_conditions(m)) %>%
  filter(n_contexts >= 1) %>%
  nrow(.)
```

Now, of the eQTLs that are specific to one context, which context is it?
```{r}
m$result$lfsr %>%
  as_tibble(rownames="gv") %>%
  pivot_longer(-gv, names_to="type", values_to="lfsr") %>%
  filter(lfsr<=0.05) %>%
  group_by(gv) %>%
  dplyr::select(-lfsr) %>%
  nest() %>%
  mutate(n_contexts=sapply(data, nrow)) %>%
  filter(n_contexts==1) %>%
  unnest(data) %>%
  mutate(type=factor(type, levels=type_levels)) %>%
  group_by(type) %>%
  dplyr::count() %>%
  ggplot(aes(x=type, y=n, fill=type)) +
  geom_bar(stat="identity") +
  theme_classic() +
  ylab("# Singleton eQTLs") +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

### What are the strongest patterns?
```{r, fig.width=6, fig.height=8}
as_tibble(get_estimated_pi(m), rownames="component") %>%
  mutate(component=factor(component, levels=names(get_estimated_pi(m)))) %>%
  ggplot(aes(x=component, y=value)) +
  geom_bar(stat="identity") +
  scale_x_discrete(limits=rev) +
  xlab("Regulatory Pattern") +
  ylab("Weight") +
  coord_flip() +
  theme_classic(base_size = 20)
  #theme(axis.text.x = element_text(angle = 45, hjust=1))
```

Show boilerplate covariance matrices
```{r fig.width=6, fig.height=3}
tibble(type=factor(type_levels, levels=type_levels), value=1) %>%
  ggplot(aes(x=type, y=value, fill=type)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values=type_colors) +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight")

tibble(type=factor(type_levels, levels=type_levels), value=c(0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 1)) %>%
  ggplot(aes(x=type, y=value, fill=type)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values=type_colors) +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight")
```

Show more interesting covariance matrices
```{r}
m$fitted_g$Ulist$ED_tPCA %>%
  corrplot(is.corr=F)

m$fitted_g$Ulist$ED_tPCA %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  #mutate(type=factor(type, levels=type_levels)) %>%
  ggplot(aes(x=type, y=value, fill=type)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight")
```

```{r}
m$fitted_g$Ulist$ED_PCA_1 %>%
  corrplot(is.corr=F)

m$fitted_g$Ulist$ED_PCA_1 %>%
  princomp %>%
  .$loadings %>%
  .[,1] %>%
  as_tibble(rownames="type") %>%
  #mutate(type=factor(type, levels=type_levels)) %>%
  ggplot(aes(x=type, y=value, fill=type)) +
  geom_bar(stat="identity") +
  theme_classic(base_size=15) +
  theme(axis.text.x = element_text(angle=30, hjust=1), legend.position="none") +
  xlab("Cell Type") + ylab("Weight")
```

Find any significant eQTLs whose effects are best explained by those signals, starting with component 1 (which is highest in IPSC, lower elsewhere)
```{r}
tests <- rownames(get_lfsr(m))
sighits <- get_significant_results(m)
ident <- as_tibble(m$posterior_weights) %>%
  rowid_to_column() %>%
  filter(rowid %in% sighits) %>%
  pivot_longer(-rowid, names_to="component", values_to="weight") %>%
  group_by(rowid) %>%
  slice_max(weight) %>%
  filter(component=="identity.13") %>%
  pull(rowid)
mash_plot_meta(m, ident[1])
mash_plot_meta(m, ident[2])
mash_plot_meta(m, ident[3])
mash_plot_meta(m, ident[4])
mash_plot_meta(m, ident[5])
mash_plot_meta(m, ident[6])
mash_plot_meta(m, ident[7])
```

These do all have really large confidence intervals

Why so many hits from visceral neurons?
```{r}
visc_qtl <- vroom("/project2/gilad/jpopp/ebQTL/results/mashr/pseudobulk/type/highpass_cellid_confident/eqtls/Visceral-neurons/eqtls.mtc.tsv") %>%
  unite(gv, SNP, gene, sep="--")

visc_tophits <- vroom("/project2/gilad/jpopp/ebQTL/results/mashr/pseudobulk/type/highpass_cellid_confident/eqtls/Visceral-neurons/eqtls.tophits.tsv")
```
```{r}
hist(qvalue(visc_qtl$`p-value`))
```


## What's going wrong?
There's clearly something off about developing eye, likely having to do with the crazy discrepancy in the number of cells per donor. Let's take a look at the eQTL summary statistics from that cell type. Do they look similar to another cell type (let's say, post mitotic neurons)
```{r}
cm_qtl <- vroom("/project2/gilad/jpopp/ebQTL/results/mashr/pseudobulk/type/highpass_cellid_confident/eqtls/Cardiomyocytes/eqtls.mtc.tsv") %>%
  unite(gv, SNP, gene, sep="--") %>%
  mutate(type="cm")

cm_tophits <- vroom("/project2/gilad/jpopp/ebQTL/results/mashr/pseudobulk/type/highpass_cellid_confident/eqtls/Cardiomyocytes/eqtls.tophits.tsv")


```

Did I filter to genes with non-zero variance in this context - no, CM has 5K genes with zero variance. should also filter to genes with at least n individuals with non-zero expression (let's say 10 for now)
```{r}
test <- vroom("/project2/gilad/jpopp/ebQTL/data/single_cell_objects/highpass_cellid_confident.pseudobulk.tsv")
cm_exp <- dplyr::select(test, c(gene, ends_with("Cardiomyocytes"))) %>% column_to_rownames(gene)

cm_log <- cm_exp > 0
hist(rowMeans(cm_exp))

genes_keep <- rownames(cm_log)[rowVars(as.matrix(cm_exp)) > 0]

cm_realtophits <- cm_tophits %>%
  filter(gene %in% genes_keep)

hist(qvalue(cm_realtophits$`p-value`)) # all better!!
```


```{r}
eye_qtl_tophits <- vroom("/project2/gilad/jpopp/ebQTL/results/mashr/pseudobulk/type/highpass_030222_lowres/eqtls/developingEye/eqtls.tophits.tsv") %>%
  unite(gv, SNP, gene, sep="--") %>%
  mutate(type="eye")

neur_qtl_tophits <- vroom("/project2/gilad/jpopp/ebQTL/results/mashr/pseudobulk/type/highpass_030222_lowres/eqtls/PostMitoticNeurons/eqtls.tophits.tsv") %>%
  unite(gv, SNP, gene, sep="--") %>%
  mutate(type="neuron")

tophits_combined <- bind_rows(eye_qtl_tophits, neur_qtl_tophits)
```


First, a broad look at the distribution of effect sizes and t-statistics for these data

```{r}
ggplot(qtl_combined, aes(x=beta)) +
  geom_histogram(nbins=30) +
  facet_grid(rows=vars(type))
```

```{r}
ggplot(qtl_combined, aes(x=`t-stat`)) +
  geom_histogram(nbins=30) +
  facet_grid(rows=vars(type))
```

```{r}
ggplot(qtl_combined, aes(x=`p-value`)) +
  geom_histogram(nbins=100) +
  facet_grid(rows=vars(type))
```

How many significant hits are there in either cell type?
```{r}
tophits_combined %>%
  filter(q <= 0.05) %>%
  dplyr::count(type)
```

How much agreement is there between the effect size measurements in the two cell types?
```{r}
double.tested <- qtl_combined %>%
  dplyr::count(gv) %>%
  filter(n==2) %>%
  pull(gv)
```

```{r}
p.comp <- qtl_combined %>%
  filter(gv %in% double.tested) %>%
  mutate(logp=-log10(`p-value`)) %>%
  pivot_wider(id_cols=gv, names_from=type, values_from=logp) %>%
  sample_frac(0.1)
ggplot(p.comp, aes(x=neuron, y=eye)) +
  geom_point()
```
How does this compare to another pair of contexts?
```{r}
endo_qtl <- vroom("/project2/gilad/jpopp/ebQTL/results/mashr/pseudobulk/type/highpass_030222_lowres/eqtls/endoderm/eqtls.mtc.tsv") %>%
  unite(gv, SNP, gene, sep="--") %>%
  mutate(type="endo")

meso_qtl <- vroom("/project2/gilad/jpopp/ebQTL/results/mashr/pseudobulk/type/highpass_030222_lowres/eqtls/MesodermEndothelialHematopoetic/eqtls.mtc.tsv") %>%
  unite(gv, SNP, gene, sep="--") %>%
  mutate(type="meso")

mesendo_combined <- bind_rows(endo_qtl, meso_qtl)
```
```{r}
double.tested2 <- mesendo_combined %>%
  dplyr::count(gv) %>%
  filter(n==2) %>%
  pull(gv)

mesendo.comp <- mesendo_combined %>%
  filter(gv %in% double.tested2) %>%
  mutate(logp=-log10(`p-value`)) %>%
  pivot_wider(id_cols=gv, names_from=type, values_from=logp) %>%
  sample_frac(0.1)
ggplot(mesendo.comp, aes(x=meso, y=endo)) +
  geom_point()
```

This is greater agreement than in the others, but there isn't a *huge* difference here, so I think `mashr` might have something to do with the problem.

How would our data-driven covariance matrices differ if we didn't just use the top hits per gene, and instead used a random hit per gene? First, for each cell type how many options would we have if we used a Bonferroni cutoff of 0.25
```{r}
opts <- eye_qtl %>%
  filter(bonf.p <= 0.25) %>%
  separate(gv, into=c("snp", "gene"), sep="--") %>%
  pull(gene) %>%
  table() %>% table()

opts
sum(opts)
```

How many QTLs are there per cell type?
```{r}
hits_per_celltype <- m$result$lfsr <= 0.05
hits_per_celltype <- colSums(hits_per_celltype)
```

How many QTLs are there per cell type without mashr?
```{r}
load_qtls <- function(s) {
  t <- str_split(s, "/")[[1]][12]
  qtls <- vroom(s) %>%
    add_column(type=t)
  qtls
}

# compute standard errors, omitting tests where we can't obtain reasonable estimates
celltypes <- c('Astrocytes', 'Visceral-neurons', 'Amacrine-cells',
'Oligodendrocytes', 'Ganglion-cells', 'Smooth-muscle-cells', 
'Limbic-system-neurons', 'Vascular-endothelial-cells', 
'Photoreceptor-cells', 'CCL19-CCL21-positive-cells', 
'CLC-IL5RA-positive-cells', 'Mesangial-cells', 'AFP-ALB-positive-cells', 
'Bipolar-cells', 'Satellite-cells', 'ENS-neurons', 'ENS-glia', 
'Granule-neurons', 'Hepatoblasts', 'Microglia', 'IGFBP1-DKK1-positive-cells', 
'Purkinje-neurons', 'Epicardial-fat-cells', 'Cardiomyocytes')

qtl_files <- paste0("/project2/gilad/jpopp/ebQTL/results/mashr/pseudobulk/type/highpass_cellid_confident/eqtls/", 
                    celltypes, "/eqtls.tophits.tsv")

qtls <- map_dfr(qtl_files, load_qtls)

hits <- qtls %>%
  group_by(type) %>%
  filter(q<=0.05) %>%
  dplyr::count()
```






