```{r}
library(tidyverse)
library(vroom)
library(qvalue)
```

## Overlap with GTEx Cardiomyocytes
```{r}
load_overlap <- function(fname) {
  read_tsv(fname, 
           col_names=c("CHR", "START", "END", "EB_ENSG", "EB_HGNC", "EB_VARIANT_ID", "GTEX_CHR", "GTEX_START", "GTEX_END", "GTEX_ENSG", "GTEX_REF", "GTEX_ALT"),
           col_select=c("CHR", "START", "END", "EB_ENSG", "EB_HGNC", "EB_VARIANT_ID", "GTEX_ENSG")) %>%
    filter(EB_ENSG == GTEX_ENSG)
}
```


```{r}
cm_hlv_overlap <- load_overlap("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/CM/8pcs/eqtl_overlap.Heart_Left_Ventricle.bed") %>%
  select(EB_VARIANT_ID, EB_ENSG) %>%
  distinct()

prog_hlv_overlap <- load_overlap("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/PROG/8pcs/eqtl_overlap.Heart_Left_Ventricle.bed") %>%
  select(EB_VARIANT_ID, EB_ENSG) %>%
  distinct()

meso_hlv_overlap <- load_overlap("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/MESO/8pcs/eqtl_overlap.Heart_Left_Ventricle.bed") %>%
  select(EB_VARIANT_ID, EB_ENSG) %>%
  distinct()

mesendo_hlv_overlap <- load_overlap("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/MESENDO/8pcs/eqtl_overlap.Heart_Left_Ventricle.bed") %>%
  select(EB_VARIANT_ID, EB_ENSG) %>%
  distinct()

ipsc_hlv_overlap <- load_overlap("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/IPSC/8pcs/eqtl_overlap.Heart_Left_Ventricle.bed") %>%
  select(EB_VARIANT_ID, EB_ENSG) %>%
  distinct()
```

## Overlap with Sarkar's IPSCs
```{r}
sarkar_sumstats <- read_tsv("/project2/gilad/jpopp/ebQTL/results/benchmark_static_qtl_calling/vqtl_ipsc/pseudobulk_tmm/basic/IPSC/8pcs/matrixeqtl_homoscedastic.cis_qtl_pairs.all.tsv") %>%
  unite(gv, gene, SNP, sep="--")
```

```{r}
ipsc_ipsc_replication <- read_tsv("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cmstages/pseudobulk_tmm/basic/IPSC/8pcs/tensorqtl_permutations.sighits.pos") %>%
  mutate(gv=paste0(GENE, "--", `#CHR`, "_", POS), .keep="unused") %>%
  left_join(sarkar_sumstats) %>%
  drop_na() %>%
  pull(`p-value`) %>%
  qvalue(lambda=0.85) %>%
  .$pi0 %>% (function(x){1-x})

mesendo_ipsc_replication <- read_tsv("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cmstages/pseudobulk_tmm/basic/MESENDO/8pcs/tensorqtl_permutations.sighits.pos") %>%
  mutate(gv=paste0(GENE, "--", `#CHR`, "_", POS), .keep="unused") %>%
  left_join(sarkar_sumstats) %>%
  drop_na() %>%
  pull(`p-value`) %>%
  qvalue(lambda=0.85) %>%
  .$pi0 %>% (function(x){1-x})

meso_ipsc_replication <- read_tsv("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cmstages/pseudobulk_tmm/basic/MESO/8pcs/tensorqtl_permutations.sighits.pos") %>%
  mutate(gv=paste0(GENE, "--", `#CHR`, "_", POS), .keep="unused") %>%
  left_join(sarkar_sumstats) %>%
  drop_na() %>%
  pull(`p-value`) %>%
  qvalue(lambda=0.85) %>%
  .$pi0 %>% (function(x){1-x})

prog_ipsc_replication <- read_tsv("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cmstages/pseudobulk_tmm/basic/PROG/8pcs/tensorqtl_permutations.sighits.pos") %>%
  mutate(gv=paste0(GENE, "--", `#CHR`, "_", POS), .keep="unused") %>%
  left_join(sarkar_sumstats) %>%
  drop_na() %>%
  pull(`p-value`) %>%
  qvalue(lambda=0.85) %>%
  .$pi0 %>% (function(x){1-x})

cm_ipsc_replication <- read_tsv("/project2/gilad/jpopp/ebQTL/results/static_qtl_calling/eb_cmstages/pseudobulk_tmm/basic/CM/8pcs/tensorqtl_permutations.sighits.pos") %>%
  mutate(gv=paste0(GENE, "--", `#CHR`, "_", POS), .keep="unused") %>%
  left_join(sarkar_sumstats) %>%
  drop_na() %>%
  pull(`p-value`) %>%
  qvalue(lambda=0.85) %>%
  .$pi0 %>% (function(x){1-x})
```

## Overlap with I2QTL IPSCs
```{r}
cm_ipsc_overlap <- load_overlap("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/CM/8pcs/eqtl_overlap.I2QTL_IPSC_hg38.bed") %>%
  select(EB_VARIANT_ID, EB_ENSG) %>%
  distinct()

prog_ipsc_overlap <- load_overlap("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/PROG/8pcs/eqtl_overlap.I2QTL_IPSC_hg38.bed") %>%
  select(EB_VARIANT_ID, EB_ENSG) %>%
  distinct()

meso_ipsc_overlap <- load_overlap("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/MESO/8pcs/eqtl_overlap.I2QTL_IPSC_hg38.bed") %>%
  select(EB_VARIANT_ID, EB_ENSG) %>%
  distinct()

mesendo_ipsc_overlap <- load_overlap("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/MESENDO/8pcs/eqtl_overlap.I2QTL_IPSC_hg38.bed") %>%
  select(EB_VARIANT_ID, EB_ENSG) %>%
  distinct()

ipsc_ipsc_overlap <- load_overlap("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/IPSC/8pcs/eqtl_overlap.I2QTL_IPSC_hg38.bed") %>%
  select(EB_VARIANT_ID, EB_ENSG) %>%
  distinct()
```

```{r}
tibble(celltype=factor(c("IPSC", "MESENDO", "MESO", "PROG", "CM"), levels=c("IPSC", "MESENDO", "MESO", "PROG", "CM")),
       gtex_=c(nrow(ipsc_hlv_overlap)/163, nrow(mesendo_hlv_overlap)/143,
                 nrow(meso_hlv_overlap)/55, nrow(prog_hlv_overlap)/63,
                 nrow(cm_hlv_overlap)/24)) %>%
  ggplot(aes(x=celltype, y=n_eqtl)) +
  geom_bar(stat="identity") + 
  theme_classic(base_size=14) +
  theme(legend.position="none")
```

```{r}
replication_viz <- tibble(celltype=factor(c("IPSC", "MESENDO", "MESO", "PROG", "CM"), levels=c("IPSC", "MESENDO", "MESO", "PROG", "CM")),
       cm_overlap=c(nrow(ipsc_hlv_overlap)/163, nrow(mesendo_hlv_overlap)/143,
                 nrow(meso_hlv_overlap)/55, nrow(prog_hlv_overlap)/63,
                 nrow(cm_hlv_overlap)/24),
       ipsc_overlap=c(nrow(ipsc_ipsc_overlap)/163, nrow(mesendo_ipsc_overlap)/143,
                 nrow(meso_ipsc_overlap)/55, nrow(prog_ipsc_overlap)/63,
                 nrow(cm_ipsc_overlap)/24)) %>%
  pivot_longer(!celltype, names_to="replication_df", values_to="overlap")
```

```{r}
ggplot(replication_viz, aes(x = celltype, y = overlap, fill = replication_df)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("#B51700", "gray")) +
  labs(x = "Stage", y = "Proportion of eQTLs Tagging a Known eQTL", fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) 

# +
#   scale_y_continuous(name = "Overlap with I2QTL IPSCs", sec.axis = sec_axis(~., name = "Overlap with GTEx Heart Left Ventricle"))
```

#### Hypergeometric test approach
In parentheses is the analog in a (N/K/n/k breakdown, verbal breakdown w balls in urn, R breakdown)

How many tests were run for EBs in each cell type? (N, total balls in urn, n+m)
```{r}
N_ipsc <- 1406201
N_mesendo <- 1394817
N_meso <- 1231892
N_prog <- 1237313
N_cm <- 1132996
```

How many tests tag an I2QTL eQTL? (K, white balls in urn, m)
```{r}
K_i2qtl_ipsc <- read.table("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/IPSC/8pcs/n_tests_tagging_gtex.I2QTL_IPSC_hg38.bed")$V1
K_i2qtl_mesendo <- read.table("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/MESENDO/8pcs/n_tests_tagging_gtex.I2QTL_IPSC_hg38.bed")$V1
K_i2qtl_meso <- read.table("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/MESO/8pcs/n_tests_tagging_gtex.I2QTL_IPSC_hg38.bed")$V1
K_i2qtl_prog <- read.table("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/PROG/8pcs/n_tests_tagging_gtex.I2QTL_IPSC_hg38.bed")$V1
K_i2qtl_cm <- read.table("/project2/gilad/jpopp/ebQTL/results/static_eqtl_followup/eb_cmstages/pseudobulk_tmm/basic/CM/8pcs/n_tests_tagging_gtex.I2QTL_IPSC_hg38.bed")$V1
```

How many EB hits did we find? (n, number of balls sampled, k)
```{r}
n_ipsc_hits <- 163
n_mesendo_hits <- 143
n_meso_hits <- 55
n_prog_hits <- 63
n_cm_hits <- 24
```

How many EB hits tag an I2QTL eQTL? (k, number of white balls, x/q)
```{r}
k_i2qtl_ipsc <- nrow(ipsc_ipsc_overlap)
k_i2qtl_mesendo <- nrow(mesendo_ipsc_overlap)
k_i2qtl_meso <- nrow(meso_ipsc_overlap)
k_i2qtl_prog <- nrow(prog_ipsc_overlap)
k_i2qtl_cm <- nrow(cm_ipsc_overlap)
```


```{r}
ipsc_i2qtl_enrichment <- -phyper(q=k_i2qtl_ipsc, 
                               m=K_i2qtl_ipsc, 
                               n=N_ipsc-K_i2qtl_ipsc,
                               k=n_ipsc_hits, 
                               lower.tail=F, log.p=T)

mesendo_i2qtl_enrichment <- -phyper(q=k_i2qtl_mesendo, 
                               m=K_i2qtl_mesendo, 
                               n=N_mesendo-K_i2qtl_mesendo,
                               k=n_mesendo_hits, 
                               lower.tail=F, log.p=T)

meso_i2qtl_enrichment <- -phyper(q=k_i2qtl_meso, 
                               m=K_i2qtl_meso, 
                               n=N_meso-K_i2qtl_meso,
                               k=n_meso_hits, 
                               lower.tail=F, log.p=T)

prog_i2qtl_enrichment <- -phyper(q=k_i2qtl_prog, 
                               m=K_i2qtl_prog, 
                               n=N_prog-K_i2qtl_prog,
                               k=n_prog_hits, 
                               lower.tail=F, log.p=T)

cm_i2qtl_enrichment <- -phyper(q=k_i2qtl_cm, 
                               m=K_i2qtl_cm, 
                               n=N_cm-K_i2qtl_cm,
                               k=n_cm_hits, 
                               lower.tail=F, log.p=T)
```


```{r}
replication_viz <- tibble(celltype=factor(c("IPSC", "MESENDO", "MESO", "PROG", "CM"), levels=c("IPSC", "MESENDO", "MESO", "PROG", "CM")),
       cm_overlap=c(ipsc_hlv_enrichment, mesendo_hlv_enrichment,
                 meso_hlv_enrichment, prog_hlv_enrichment,
                 cm_hlv_enrichment),
       ipsc_overlap=c(ipsc_ipsc_enrichment, mesendo_ipsc_enrichment,
                 meso_ipsc_enrichment, prog_ipsc_enrichment,
                 cm_ipsc_enrichment))
replication_viz_long <- replication_viz %>%
  pivot_longer(!celltype, names_to="replication_df", values_to="overlap")
```

```{r}
scale_factor = max(replication_viz$cm_overlap) / max(replication_viz$ipsc_overlap)

ggplot(replication_viz_long, aes(x = celltype, fill = replication_df)) +
  geom_col(position = position_dodge(width = 0.9),
    aes(y = ifelse(replication_df == "cm_overlap", overlap, overlap * scale_factor))) +
  scale_fill_manual(values = c("#B51700", "gray")) +
  labs(x = "Stage") +
  theme_bw(base_size=15) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "none") +
  scale_y_continuous(name = "-log P(Heart Enrichment)", expand = c(0, 0.05), sec.axis = sec_axis(~ . / scale_factor, name = "-log P(IPSC Enrichment)")) +
  theme(axis.title.y.right = element_text(color="#5E5E5E")) +
  theme(axis.title.y.left = element_text(color="#B51700"))
```

## Reran the analysis
This time, number of white balls in the urn corresponds to the number of QTLs in the reference
dataset that are within 1kb of an EB test. The sampling procedure remains the selection of hits 
in an EB cell type, so
N = # EB tests
K = # GTEx/I2QTL hits within 1kb of an EB test (tested against same gene, etc)
n = # EB hits
k = # EB hits within 1kb of a GTEx/ I2QTL hit
```{r}
tibble("EB_Celltype -- Reference Dataset"=c("EB_IPSC -- I2QTL", "EB_IPSC -- GTEx", "EB_CM -- I2QTL", "EB_CM -- GTEx"),
       "-log10(P Enrichment)"=c(20.94, 45.98, 11.97, 17.28)) %>%
  ggplot(aes(x=`EB_Celltype -- Reference Dataset`, y=`-log10(P Enrichment)`)) +
  geom_col()
```

