---
title: "Normalization and Preprocessing"
output: html_notebook
---

```{r}
library(tidyverse)
library(scran)
```


## Normalization with library size vs deconvolution 
```{r}
eb_lowpass_libsizeprocessed_dir <- "/project2/gilad/jpopp/ebQTL/data/single_cell_objects/Lowpass.3seqbatches.merged.TEMP.libsize.normalized.sce"
eb_lowpass_libsizedec_dir <- "/project2/gilad/jpopp/ebQTL/data/single_cell_objects/Lowpass.3seqbatches.merged.TEMP.libsize.decomposed.rds"
eb_lowpass_scranprocessed_dir <- "/project2/gilad/jpopp/ebQTL/data/single_cell_objects/Lowpass.3seqbatches.merged.TEMP.scran.normalized.sce"
eb_lowpass_scrandec_dir <- "/project2/gilad/jpopp/ebQTL/data/single_cell_objects/Lowpass.3seqbatches.merged.TEMP.decomposed.rds"

eb_lowpass_libsize <- readRDS(eb_lowpass_libsizeprocessed_dir)
eb_lowpass_scran <- readRDS(eb_lowpass_scranprocessed_dir)
eb_lowpass_libsize_dec <- readRDS(eb_lowpass_libsizedec_dir)
eb_lowpass_scran_dec <- readRDS(eb_lowpass_scrandec_dir)
```

### Highly variable features
First, do the two approaches decide on the same (or approximately the same) set of HVF?
```{r}
hvf_libsize <- getTopHVGs(eb_lowpass_libsize_dec, fdr.threshold=0.1)
hvf_scran <- getTopHVGs(eb_lowpass_scran_dec, fdr.threshold=0.1)

hvf_libsize_3k <- getTopHVGs(eb_lowpass_libsize_dec, n=3000)
hvf_scran_3k <- getTopHVGs(eb_lowpass_scran_dec, n=3000)
```

When selecting a set of highly variable features, if you simply choose the top 3000 features, 92.6% overlap between the two approaches. If you choose by FDR threshold, scran normalization returns 25% more features than library soze normalization, but still, almost 80% of the features selected by scran are also selected by library size normalization. So judging by HVF set alone, it's not a huge difference. 

### Marker gene expression 
First, we see that the distribution of housekeeping genes is highly comparable across the two approaches
```{r}
hkg <- c("ATXN2", "NME4", "SAMD4B", "PTPN14")

hkg_scran <- assay(eb_lowpass_scran, "logcounts")[hkg,] %>%
  t %>% as.matrix %>% as_tibble(rownames="cell") %>% mutate(norm="scran")
hkg_libsize <- assay(eb_lowpass_libsize, "logcounts")[hkg,] %>%
  t %>% as.matrix %>% as_tibble(rownames="cell")%>% mutate(norm="libsize")

hkg_hist <- bind_rows(hkg_scran, hkg_libsize) %>%
  pivot_longer(all_of(hkg), names_to="gene", values_to="exp")

ggplot(hkg_hist, aes(x=exp)) +
  geom_histogram() +
  facet_grid(rows=vars(gene), cols=vars(norm), scales="free") +
  theme_classic(base_size=12) +
  xlab("Expression") + ylab("Num. Cells") +
  ggtitle("Housekeeping Genes")

hkg_cor <- hkg_hist %>%
  pivot_wider(names_from="norm", values_from="exp")

ggplot(hkg_cor, aes(x=libsize, y=scran)) +
  geom_point() +
  geom_abline(slope=1, intercept=0) +
  facet_grid(rows=vars(gene))
```

```{r}
hvg <- c("POU5F1", "SOX17", "HAND1", "PAX6")

hvg_scran <- assay(eb_lowpass_scran, "logcounts")[hvg,] %>%
  t %>% as.matrix %>% as_tibble(rownames="cell") %>% mutate(norm="scran")
hvg_libsize <- assay(eb_lowpass_libsize, "logcounts")[hvg,] %>%
  t %>% as.matrix %>% as_tibble(rownames="cell") %>% mutate(norm="libsize")

hvg_hist <- bind_rows(hvg_scran, hvg_libsize) %>%
  pivot_longer(all_of(hvg), names_to="gene", values_to="exp")

ggplot(hvg_hist, aes(x=exp)) +
  geom_histogram() +
  facet_grid(rows=vars(gene), cols=vars(norm), scales="free") +
  theme_classic(base_size=12) +
  xlab("Expression") + ylab("Num. Cells") +
  ggtitle("Marker Genes")

ggplot(filter(hvg_hist, exp>0), aes(x=exp)) +
  geom_histogram() +
  facet_grid(rows=vars(gene), cols=vars(norm), scales="free") +
  theme_classic(base_size=12) +
  xlab("Expression") + ylab("Num. Cells") +
  ggtitle("Marker Genes, Nonzero Cells")

hvg_cor <- hvg_hist %>%
  pivot_wider(names_from="norm", values_from="exp")

ggplot(hvg_cor, aes(x=libsize, y=scran)) +
  geom_point() +
  geom_abline(slope=1, intercept=0) +
  facet_grid(rows=vars(gene))
```

